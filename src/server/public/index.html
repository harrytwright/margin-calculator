<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Margin Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50">
    <div id="app" class="min-h-screen">
      <!-- Header -->
      <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <h1 class="text-2xl font-bold text-gray-900">üçΩÔ∏è Margin Calculator</h1>
        </div>
      </header>

      <!-- Main Content -->
      <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Loading State -->
        <div id="loading" class="text-center py-12">
          <div
            class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"
          ></div>
          <p class="mt-4 text-gray-600">Loading recipes...</p>
        </div>

        <!-- Recipe List View -->
        <div id="recipe-list" class="hidden">
          <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-900">All Recipes</h2>
            <p class="text-gray-600">
              Click on a recipe to view detailed cost breakdown
            </p>
          </div>
          <div
            id="recipes-container"
            class="grid gap-4 md:grid-cols-2 lg:grid-cols-3"
          ></div>
        </div>

        <!-- Recipe Detail View -->
        <div id="recipe-detail" class="hidden">
          <button
            id="back-btn"
            class="mb-4 text-blue-600 hover:text-blue-800 flex items-center"
          >
            <svg
              class="w-5 h-5 mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
            Back to recipes
          </button>
          <div id="detail-container"></div>
        </div>
      </main>
    </div>

    <script>
      const API_BASE = '/api'
      let currentView = 'list'

      // Fetch and display recipes
      async function loadRecipes() {
        try {
          const response = await fetch(`${API_BASE}/report`)
          const recipes = await response.json()

          document.getElementById('loading').classList.add('hidden')
          document.getElementById('recipe-list').classList.remove('hidden')

          const container = document.getElementById('recipes-container')
          container.innerHTML = recipes
            .map((recipe) => {
              if (!recipe.success) {
                return `
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <h3 class="font-semibold text-red-900">${recipe.slug}</h3>
                                <p class="text-sm text-red-600 mt-1">Error: ${recipe.error}</p>
                            </div>
                        `
              }

              const marginColor = recipe.margin.meetsTarget ? 'green' : 'red'
              const marginIcon = recipe.margin.meetsTarget ? '‚úì' : '‚úó'

              return `
                        <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow cursor-pointer"
                             onclick="loadRecipeDetail('${recipe.slug}')">
                            <h3 class="font-semibold text-gray-900 text-lg mb-2">${recipe.name}</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Cost:</span>
                                    <span class="font-medium">¬£${recipe.cost.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Sell Price:</span>
                                    <span class="font-medium">¬£${recipe.margin.sellPrice.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t">
                                    <span class="text-gray-600">Margin:</span>
                                    <span class="font-semibold text-${marginColor}-600">
                                        ${marginIcon} ${recipe.margin.actualMargin.toFixed(1)}%
                                    </span>
                                </div>
                                <div class="text-xs text-gray-500">
                                    Target: ${recipe.margin.targetMargin}%
                                </div>
                            </div>
                        </div>
                    `
            })
            .join('')
        } catch (error) {
          document.getElementById('loading').innerHTML = `
                    <div class="text-red-600">
                        <p class="font-semibold">Error loading recipes</p>
                        <p class="text-sm mt-2">${error.message}</p>
                    </div>
                `
        }
      }

      // Load recipe detail
      async function loadRecipeDetail(slug) {
        try {
          document.getElementById('recipe-list').classList.add('hidden')
          document.getElementById('recipe-detail').classList.remove('hidden')

          const response = await fetch(`${API_BASE}/recipes/${slug}/calculate`)
          const data = await response.json()

          const container = document.getElementById('detail-container')
          const marginColor = data.margin.meetsTarget ? 'green' : 'red'

          container.innerHTML = `
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">${data.recipe.name}</h2>

                        <!-- Cost Breakdown -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Cost Breakdown</h3>
                            <div class="bg-gray-50 rounded-lg p-4">
                                ${renderCostTree(data.cost.breakdown)}
                                <div class="mt-4 pt-4 border-t border-gray-300">
                                    <div class="flex justify-between text-lg font-semibold">
                                        <span>Total Cost:</span>
                                        <span>¬£${data.cost.total.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pricing & Margin -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Pricing & Margin</h3>
                            <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Sell Price (ex-VAT):</span>
                                    <span class="font-medium">¬£${data.margin.sellPrice.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Customer Price:</span>
                                    <span class="font-medium">¬£${data.margin.customerPrice.toFixed(2)}</span>
                                </div>
                                ${
                                  data.margin.vatApplicable
                                    ? `
                                    <div class="flex justify-between text-sm text-gray-500">
                                        <span>VAT:</span>
                                        <span>¬£${data.margin.vatAmount.toFixed(2)}</span>
                                    </div>
                                `
                                    : '<div class="text-sm text-gray-500">VAT not applicable</div>'
                                }
                                <div class="flex justify-between pt-3 border-t">
                                    <span class="text-gray-600">Profit:</span>
                                    <span class="font-medium text-green-600">¬£${data.margin.profit.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between items-center pt-3 border-t">
                                    <span class="text-gray-600">Margin:</span>
                                    <div class="text-right">
                                        <span class="text-2xl font-bold text-${marginColor}-600">
                                            ${data.margin.actualMargin.toFixed(1)}%
                                        </span>
                                        <div class="text-sm text-gray-500">Target: ${data.margin.targetMargin}%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `
        } catch (error) {
          document.getElementById('detail-container').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                        <p class="font-semibold text-red-900">Error loading recipe details</p>
                        <p class="text-sm text-red-600 mt-2">${error.message}</p>
                    </div>
                `
        }
      }

      // Render cost breakdown tree
      function renderCostTree(items, depth = 0) {
        return items
          .map((item) => {
            const indent = depth * 20
            const icon = item.type === 'recipe' ? 'üì¶' : 'ü•ï'

            let html = `
                    <div class="py-2" style="padding-left: ${indent}px">
                        <div class="flex justify-between items-start">
                            <span class="text-gray-700">
                                ${icon} ${item.name}
                                <span class="text-sm text-gray-500">(${item.amount} ${item.unit})</span>
                            </span>
                            <span class="font-medium text-gray-900 ml-4">¬£${item.cost.toFixed(2)}</span>
                        </div>
                    </div>
                `

            if (item.children && item.children.length > 0) {
              html += renderCostTree(item.children, depth + 1)
            }

            return html
          })
          .join('')
      }

      // Back button handler
      document.getElementById('back-btn').addEventListener('click', () => {
        document.getElementById('recipe-detail').classList.add('hidden')
        document.getElementById('recipe-list').classList.remove('hidden')
      })

      // Initialize
      loadRecipes()
    </script>
  </body>
</html>
