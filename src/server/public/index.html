<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Menu Book</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        10%,
        30%,
        50%,
        70%,
        90% {
          transform: translateX(-4px);
        }
        20%,
        40%,
        60%,
        80% {
          transform: translateX(4px);
        }
      }

      /* Highlight required fields */
      input:required:not(:focus):invalid,
      select:required:not(:focus):invalid {
        border-color: #fbbf24;
      }

      /* Smooth transitions for validation states */
      input,
      select,
      textarea {
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Modal Overlay -->
    <div
      id="modal-overlay"
      class="fixed inset-0 bg-black bg-opacity-50 hidden z-40 transition-opacity duration-200"
    ></div>

    <!-- Modal Container -->
    <div
      id="modal"
      class="fixed inset-0 flex items-center justify-center hidden z-50 pointer-events-none"
    >
      <div
        class="modal-content bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[85vh] flex flex-col pointer-events-auto transform transition-all duration-200 scale-95 opacity-0"
      >
        <div
          class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between rounded-t-lg z-10"
        >
          <h2 id="modal-title" class="text-xl font-semibold text-gray-900"></h2>
          <button
            id="modal-close"
            class="text-gray-400 hover:text-gray-600 focus:outline-none"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div
          id="modal-body"
          class="px-6 py-6 overflow-y-auto flex-1"
          style="scrollbar-gutter: stable"
        >
          <!-- Form content will be injected here -->
        </div>
      </div>
    </div>

    <!-- Toast Notification Container -->
    <div
      id="toast-container"
      class="fixed top-4 right-4 z-50 flex flex-col gap-3 pointer-events-none"
    ></div>

    <!-- Delete Confirmation Modal -->
    <div
      id="delete-modal-overlay"
      class="fixed inset-0 bg-black bg-opacity-50 hidden z-40 transition-opacity duration-200"
    ></div>
    <div
      id="delete-modal"
      class="fixed inset-0 flex items-center justify-center hidden z-50 pointer-events-none"
    >
      <div
        class="delete-modal-content bg-white rounded-lg shadow-xl max-w-md w-full mx-4 pointer-events-auto transform transition-all duration-200 scale-95 opacity-0"
      >
        <div class="px-6 py-5">
          <div class="flex items-start gap-4">
            <div
              class="flex-shrink-0 w-12 h-12 rounded-full bg-red-100 flex items-center justify-center"
            >
              <svg
                class="w-6 h-6 text-red-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                />
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-gray-900 mb-1">
                Delete <span id="delete-entity-type"></span>?
              </h3>
              <p id="delete-message" class="text-sm text-gray-600 mb-4"></p>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end rounded-b-lg">
          <button
            id="delete-cancel-btn"
            class="inline-flex items-center px-4 py-2 rounded-md border border-gray-300 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-150"
          >
            Cancel
          </button>
          <button
            id="delete-confirm-btn"
            class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-150"
          >
            Delete
          </button>
        </div>
      </div>
    </div>

    <div id="app" class="min-h-screen flex">
      <!-- Sidebar -->
      <aside class="w-64 bg-white border-r border-gray-200 flex flex-col">
        <!-- Logo/Header -->
        <div class="px-6 py-4 border-b border-gray-200">
          <h1 class="text-xl font-bold text-gray-900">üìñ Menu Book</h1>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 px-4 py-6 space-y-1">
          <!-- Dashboard -->
          <a
            href="#"
            data-view="dashboard"
            class="nav-link flex items-center px-3 py-2 text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"
          >
            <svg
              class="w-5 h-5 mr-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
              />
            </svg>
            Dashboard
          </a>

          <!-- Management Section -->
          <div class="space-y-1">
            <button
              id="management-toggle"
              class="nav-link flex items-center justify-between w-full px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100"
            >
              <span class="flex items-center">
                <svg
                  class="w-5 h-5 mr-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                  />
                </svg>
                Management
              </span>
              <svg
                id="management-chevron"
                class="w-4 h-4 transform transition-transform"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </button>

            <!-- Sub-navigation (initially hidden) -->
            <div id="management-subnav" class="hidden pl-11 space-y-1">
              <a
                href="#"
                data-view="suppliers"
                class="nav-link block px-3 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-100 hover:text-gray-900"
              >
                Suppliers
              </a>
              <a
                href="#"
                data-view="ingredients"
                class="nav-link block px-3 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-100 hover:text-gray-900"
              >
                Ingredients
              </a>
              <a
                href="#"
                data-view="recipes"
                class="nav-link block px-3 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-100 hover:text-gray-900"
              >
                Recipes
              </a>
            </div>
          </div>

          <!-- Margins -->
          <a
            href="#"
            data-view="margins"
            class="nav-link flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100"
          >
            <svg
              class="w-5 h-5 mr-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            Margins
          </a>

          <!-- Settings -->
          <a
            href="#"
            data-view="settings"
            class="nav-link flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100"
          >
            <svg
              class="w-5 h-5 mr-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
            Settings
          </a>

          <!-- Help -->
          <a
            href="#"
            data-view="help"
            class="nav-link flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100"
          >
            <svg
              class="w-5 h-5 mr-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            Help
          </a>
        </nav>
      </aside>

      <!-- Main Content Area -->
      <div class="flex-1 flex flex-col min-h-screen">
        <!-- Header Bar -->
        <header class="bg-white border-b border-gray-200 px-8 py-4">
          <div class="flex items-center justify-between gap-4">
            <h2 id="view-title" class="text-2xl font-semibold text-gray-900">
              Dashboard
            </h2>

            <!-- Search & Filters (only shown on management/margins views) -->
            <div
              id="search-filters"
              class="hidden flex-1 max-w-2xl flex items-center gap-3"
            >
              <!-- Search Input -->
              <div class="relative flex-1">
                <div
                  class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                >
                  <svg
                    class="h-5 w-5 text-gray-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                    />
                  </svg>
                </div>
                <input
                  type="text"
                  id="search-input"
                  class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                  placeholder="Search..."
                />
              </div>

              <!-- Filter Dropdown -->
              <div class="relative">
                <button
                  id="filter-toggle"
                  class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                >
                  <svg
                    class="w-4 h-4 mr-2"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
                    />
                  </svg>
                  Filters
                  <span
                    id="filter-count"
                    class="ml-2 hidden inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
                  >
                    0
                  </span>
                </button>

                <!-- Filter Dropdown Menu (hidden by default) -->
                <div
                  id="filter-menu"
                  class="hidden absolute right-0 mt-2 w-72 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10"
                >
                  <div class="p-4 space-y-4">
                    <!-- Filter by Category (for ingredients/recipes) -->
                    <div id="filter-category-group" class="hidden">
                      <label
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Category
                      </label>
                      <select
                        id="filter-category"
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                      >
                        <option value="">All Categories</option>
                      </select>
                    </div>

                    <!-- Filter by Class (for recipes) -->
                    <div id="filter-class-group" class="hidden">
                      <label
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Class
                      </label>
                      <select
                        id="filter-class"
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                      >
                        <option value="">All Classes</option>
                        <option value="menu_item">Menu Item</option>
                        <option value="base_template">Base Template</option>
                        <option value="sub_recipe">Sub Recipe</option>
                      </select>
                    </div>

                    <!-- Filter by Margin (for margins view) -->
                    <div id="filter-margin-group" class="hidden">
                      <label
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Margin Status
                      </label>
                      <select
                        id="filter-margin"
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                      >
                        <option value="">All Recipes</option>
                        <option value="below-target">Below Target</option>
                        <option value="meets-target">
                          Meets/Exceeds Target
                        </option>
                      </select>
                    </div>

                    <!-- Clear Filters Button -->
                    <div class="pt-2 border-t border-gray-200">
                      <button
                        id="clear-filters"
                        class="w-full inline-flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                      >
                        Clear All Filters
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </header>

        <!-- Content -->
        <main class="flex-1 px-8 py-8 bg-gray-50 overflow-auto">
          <!-- Dashboard View -->
          <div id="view-dashboard" class="view-content">
            <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-4 mb-8">
              <!-- Summary Cards -->
              <div
                class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm"
              >
                <h3 class="text-sm font-medium text-gray-500 mb-2">
                  Total Recipes
                </h3>
                <p
                  id="stat-total-recipes"
                  class="text-3xl font-bold text-gray-900"
                >
                  0
                </p>
              </div>
              <div
                class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm"
              >
                <h3 class="text-sm font-medium text-gray-500 mb-2">
                  Avg Margin
                </h3>
                <p
                  id="stat-avg-margin"
                  class="text-3xl font-bold text-gray-900"
                >
                  0%
                </p>
              </div>
              <div
                class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm"
              >
                <h3 class="text-sm font-medium text-gray-500 mb-2">
                  Below Target
                </h3>
                <p
                  id="stat-below-target"
                  class="text-3xl font-bold text-red-600"
                >
                  0
                </p>
              </div>
              <div
                class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm"
              >
                <h3 class="text-sm font-medium text-gray-500 mb-2">
                  Total Ingredients
                </h3>
                <p
                  id="stat-total-ingredients"
                  class="text-3xl font-bold text-gray-900"
                >
                  0
                </p>
              </div>
            </div>

            <!-- Quick Actions -->
            <div
              class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm"
            >
              <h3 class="text-lg font-semibold text-gray-900 mb-4">
                Quick Actions
              </h3>
              <div class="flex flex-wrap gap-3">
                <button
                  data-view="suppliers"
                  class="nav-action inline-flex items-center px-4 py-2 rounded-md border border-gray-300 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                >
                  + New Supplier
                </button>
                <button
                  data-view="ingredients"
                  class="nav-action inline-flex items-center px-4 py-2 rounded-md border border-gray-300 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                >
                  + New Ingredient
                </button>
                <button
                  data-view="recipes"
                  class="nav-action inline-flex items-center px-4 py-2 rounded-md border border-gray-300 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                >
                  + New Recipe
                </button>
              </div>
            </div>

            <!-- Charts Section -->
            <div class="grid gap-6 md:grid-cols-2 mt-8">
              <!-- Margin Distribution Chart -->
              <div
                class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm"
              >
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                  Margin Distribution
                </h3>
                <div class="h-64">
                  <canvas id="margin-distribution-chart"></canvas>
                </div>
              </div>

              <!-- Top Performers Chart -->
              <div
                class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm"
              >
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                  Top 5 Most Profitable
                </h3>
                <div class="h-64">
                  <canvas id="top-performers-chart"></canvas>
                </div>
              </div>

              <!-- Category Breakdown Chart -->
              <div
                class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm md:col-span-2"
              >
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                  Recipes by Category
                </h3>
                <div class="h-64 flex items-center justify-center">
                  <canvas
                    id="category-breakdown-chart"
                    class="max-h-64"
                  ></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Suppliers View -->
          <div id="view-suppliers" class="view-content hidden">
            <div
              class="bg-white border border-gray-200 rounded-lg shadow-sm p-6 space-y-6"
            >
              <!-- Suppliers Manager -->
              <div id="manager-suppliers" class="manager-panel space-y-6">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-semibold text-gray-900">Suppliers</h3>
                  <button
                    id="new-supplier-btn"
                    type="button"
                    class="inline-flex items-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                  >
                    <svg
                      class="w-5 h-5 mr-2"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 4v16m8-8H4"
                      />
                    </svg>
                    New Supplier
                  </button>
                </div>

                <div>
                  <div
                    id="supplier-list"
                    class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3"
                  ></div>
                </div>

                <!-- Hidden form template -->
                <form id="supplier-form" class="hidden space-y-5">
                  <!-- Supplier Name Field -->
                  <div>
                    <label
                      for="supplier-name"
                      class="block text-sm font-medium text-gray-700 mb-2"
                    >
                      Supplier Name <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                      <input
                        id="supplier-name"
                        name="name"
                        type="text"
                        required
                        placeholder="e.g., Tesco, ASDA, Sysco"
                        class="block w-full px-4 py-2.5 pr-10 text-gray-900 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-150 placeholder:text-gray-400"
                      />
                      <div
                        class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"
                      >
                        <svg
                          id="supplier-name-valid"
                          class="w-5 h-5 text-green-500 hidden"
                          fill="currentColor"
                          viewBox="0 0 20 20"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                            clip-rule="evenodd"
                          />
                        </svg>
                        <svg
                          id="supplier-name-error"
                          class="w-5 h-5 text-red-500 hidden"
                          fill="currentColor"
                          viewBox="0 0 20 20"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                            clip-rule="evenodd"
                          />
                        </svg>
                      </div>
                    </div>
                    <p
                      id="supplier-name-hint"
                      class="mt-1.5 text-xs text-gray-500 hidden"
                    >
                      Name should be at least 2 characters
                    </p>
                    <p
                      id="supplier-name-error-msg"
                      class="mt-1.5 text-xs text-red-600 hidden"
                    ></p>
                  </div>

                  <div class="flex items-center gap-3">
                    <button
                      type="submit"
                      id="supplier-submit-btn"
                      disabled
                      class="inline-flex items-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-150"
                    >
                      Save Supplier
                    </button>
                    <button
                      type="button"
                      id="supplier-reset"
                      class="inline-flex items-center px-3 py-2 rounded-md border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-50"
                    >
                      Clear
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Ingredients View -->
          <div id="view-ingredients" class="view-content hidden">
            <div
              class="bg-white border border-gray-200 rounded-lg shadow-sm p-6 space-y-6"
            >
              <!-- Ingredients Manager -->
              <div
                id="manager-ingredients"
                class="manager-panel space-y-6 hidden"
              >
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-semibold text-gray-900">
                    Ingredients
                  </h3>
                  <button
                    id="new-ingredient-btn"
                    type="button"
                    class="inline-flex items-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                  >
                    <svg
                      class="w-5 h-5 mr-2"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 4v16m8-8H4"
                      />
                    </svg>
                    New Ingredient
                  </button>
                </div>

                <div>
                  <div
                    id="ingredient-list"
                    class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3"
                  ></div>
                </div>

                <!-- Hidden form template -->
                <form id="ingredient-form" class="hidden space-y-5">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <!-- Ingredient Name -->
                    <div>
                      <label
                        for="ingredient-name"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Ingredient Name <span class="text-red-500">*</span>
                      </label>
                      <div class="relative">
                        <input
                          id="ingredient-name"
                          name="name"
                          type="text"
                          required
                          placeholder="e.g., Cheddar Cheese, Olive Oil"
                          class="block w-full px-4 py-2.5 pr-10 text-gray-900 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-150 placeholder:text-gray-400"
                        />
                        <div
                          class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"
                        >
                          <svg
                            id="ingredient-name-valid"
                            class="w-5 h-5 text-green-500 hidden"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                          >
                            <path
                              fill-rule="evenodd"
                              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                              clip-rule="evenodd"
                            />
                          </svg>
                        </div>
                      </div>
                    </div>

                    <!-- Category -->
                    <div>
                      <label
                        for="ingredient-category"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Category <span class="text-red-500">*</span>
                      </label>
                      <div class="relative">
                        <input
                          id="ingredient-category"
                          name="category"
                          type="text"
                          required
                          placeholder="e.g., Dairy, Meat, Vegetables"
                          class="block w-full px-4 py-2.5 pr-10 text-gray-900 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-150 placeholder:text-gray-400"
                        />
                        <div
                          class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"
                        >
                          <svg
                            id="ingredient-category-valid"
                            class="w-5 h-5 text-green-500 hidden"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                          >
                            <path
                              fill-rule="evenodd"
                              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                              clip-rule="evenodd"
                            />
                          </svg>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <!-- Purchase Unit -->
                    <div>
                      <label
                        for="ingredient-unit"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Purchase Unit <span class="text-red-500">*</span>
                      </label>
                      <div class="relative">
                        <input
                          id="ingredient-unit"
                          name="purchaseUnit"
                          type="text"
                          required
                          placeholder="e.g., 1kg, 500g, 2L, 12 pack"
                          class="block w-full px-4 py-2.5 pr-10 text-gray-900 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-150 placeholder:text-gray-400"
                        />
                        <div
                          class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"
                        >
                          <svg
                            id="ingredient-unit-valid"
                            class="w-5 h-5 text-green-500 hidden"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                          >
                            <path
                              fill-rule="evenodd"
                              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                              clip-rule="evenodd"
                            />
                          </svg>
                        </div>
                      </div>
                    </div>

                    <!-- Purchase Cost -->
                    <div>
                      <label
                        for="ingredient-cost"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Purchase Cost (¬£) <span class="text-red-500">*</span>
                      </label>
                      <div class="relative">
                        <input
                          id="ingredient-cost"
                          name="purchaseCost"
                          type="number"
                          min="0"
                          step="0.01"
                          required
                          placeholder="0.00"
                          class="block w-full px-4 py-2.5 pr-10 text-gray-900 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-150 placeholder:text-gray-400"
                        />
                        <div
                          class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"
                        >
                          <svg
                            id="ingredient-cost-valid"
                            class="w-5 h-5 text-green-500 hidden"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                          >
                            <path
                              fill-rule="evenodd"
                              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                              clip-rule="evenodd"
                            />
                          </svg>
                        </div>
                      </div>
                      <p class="mt-1.5 text-xs text-gray-500">Price ex-VAT</p>
                    </div>
                  </div>

                  <!-- VAT & Supplier Row -->
                  <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex items-center">
                      <label
                        class="inline-flex items-center text-sm font-medium text-gray-700 cursor-pointer"
                      >
                        <input
                          id="ingredient-vat"
                          name="purchaseVat"
                          type="checkbox"
                          class="rounded border-gray-300 text-blue-600 shadow-sm focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 w-4 h-4 transition-all duration-150"
                        />
                        <span class="ml-2">Price includes VAT</span>
                      </label>
                    </div>

                    <div class="flex-1">
                      <label
                        for="ingredient-supplier"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        üè™ Supplier
                        <span class="text-gray-400">(optional)</span>
                      </label>
                      <div class="relative">
                        <select
                          id="ingredient-supplier"
                          name="supplier"
                          class="block w-full px-4 py-2.5 pr-10 text-gray-900 bg-white border border-gray-300 rounded-lg shadow-sm appearance-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-150 disabled:bg-gray-100 disabled:text-gray-500 disabled:cursor-not-allowed"
                        >
                          <option value="">Select a supplier</option>
                        </select>
                        <div
                          class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"
                        >
                          <svg
                            class="w-4 h-4 text-gray-400"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M19 9l-7 7-7-7"
                            />
                          </svg>
                        </div>
                      </div>
                      <p
                        id="ingredient-supplier-help"
                        class="mt-1.5 text-xs text-amber-600 hidden"
                      >
                        ‚ö†Ô∏è Supplier cannot be changed after creation
                      </p>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Conversion Rule -->
                    <div>
                      <label
                        for="ingredient-conversion"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Conversion Rule
                        <span class="text-gray-400">(optional)</span>
                      </label>
                      <input
                        id="ingredient-conversion"
                        name="conversionRate"
                        type="text"
                        placeholder="e.g., 1 loaf = 16 slices"
                        class="block w-full px-4 py-2.5 text-gray-900 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-150"
                      />
                    </div>

                    <!-- Notes -->
                    <div>
                      <label
                        for="ingredient-notes"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Notes <span class="text-gray-400">(optional)</span>
                      </label>
                      <input
                        id="ingredient-notes"
                        name="notes"
                        type="text"
                        placeholder="Any additional info"
                        class="block w-full px-4 py-2.5 text-gray-900 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-150"
                      />
                    </div>
                  </div>

                  <div class="flex items-center gap-3 pt-2">
                    <button
                      type="submit"
                      id="ingredient-submit-btn"
                      disabled
                      class="inline-flex items-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-150"
                    >
                      Save Ingredient
                    </button>
                    <button
                      type="button"
                      id="ingredient-reset"
                      class="inline-flex items-center px-3 py-2 rounded-md border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-all duration-150"
                    >
                      Clear
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Recipes View -->
          <div id="view-recipes" class="view-content hidden">
            <div
              class="bg-white border border-gray-200 rounded-lg shadow-sm p-6 space-y-6"
            >
              <!-- Recipes Manager -->
              <div id="manager-recipes" class="manager-panel space-y-6 hidden">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-semibold text-gray-900">Recipes</h3>
                  <button
                    id="new-recipe-btn"
                    type="button"
                    class="inline-flex items-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                  >
                    <svg
                      class="w-5 h-5 mr-2"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 4v16m8-8H4"
                      />
                    </svg>
                    New Recipe
                  </button>
                </div>

                <div>
                  <div
                    id="recipe-manager-list"
                    class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3"
                  ></div>
                </div>

                <!-- Hidden form template -->
                <form id="recipe-form" class="hidden space-y-6">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <label
                        for="recipe-name"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Recipe Name <span class="text-red-500">*</span>
                      </label>
                      <input
                        id="recipe-name"
                        name="name"
                        type="text"
                        required
                        placeholder="e.g., Margherita Pizza, Club Sandwich"
                        class="block w-full px-4 py-2.5 text-gray-900 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    <div>
                      <label
                        for="recipe-category"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Category <span class="text-gray-400">(optional)</span>
                      </label>
                      <input
                        id="recipe-category"
                        name="category"
                        type="text"
                        placeholder="e.g., Pizza, Sandwiches, Desserts"
                        class="block w-full px-4 py-2.5 text-gray-900 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                      <label
                        for="recipe-stage"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Stage <span class="text-red-500">*</span>
                      </label>
                      <select
                        id="recipe-stage"
                        name="stage"
                        class="block w-full px-4 py-2.5 text-gray-900 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      >
                        <option value="development">Development</option>
                        <option value="active">Active</option>
                        <option value="discontinued">Discontinued</option>
                      </select>
                    </div>
                    <div>
                      <label
                        for="recipe-class"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Class <span class="text-red-500">*</span>
                      </label>
                      <select
                        id="recipe-class"
                        name="class"
                        class="block w-full px-4 py-2.5 text-gray-900 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      >
                        <option value="menu_item">Menu Item</option>
                        <option value="base_template">Base Template</option>
                        <option value="sub_recipe">Sub Recipe</option>
                      </select>
                    </div>
                    <div>
                      <label
                        for="recipe-parent"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Extends <span class="text-gray-400">(optional)</span>
                      </label>
                      <select
                        id="recipe-parent"
                        name="extends"
                        class="block w-full px-4 py-2.5 text-gray-900 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      >
                        <option value="">-- None --</option>
                      </select>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                      <label
                        for="recipe-price"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Target Price <span class="text-red-500">*</span>
                      </label>
                      <input
                        id="recipe-price"
                        name="price"
                        type="number"
                        min="0"
                        step="1"
                        required
                        placeholder="e.g., 450"
                        class="block w-full px-4 py-2.5 text-gray-900 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                      <p class="mt-1.5 text-xs text-gray-500">
                        Price in pence, ex-VAT
                      </p>
                    </div>
                    <div>
                      <label
                        for="recipe-margin"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Target Margin
                        <span class="text-gray-400">(optional)</span>
                      </label>
                      <input
                        id="recipe-margin"
                        name="margin"
                        type="number"
                        min="0"
                        max="100"
                        step="1"
                        placeholder="e.g., 65"
                        class="block w-full px-4 py-2.5 text-gray-900 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                      <p class="mt-1.5 text-xs text-gray-500">
                        Target margin %
                      </p>
                    </div>
                    <div class="flex items-start pt-8">
                      <label
                        class="inline-flex items-center text-sm font-medium text-gray-700 cursor-pointer"
                      >
                        <input
                          id="recipe-vat"
                          name="vat"
                          type="checkbox"
                          class="rounded border-gray-300 text-blue-600 shadow-sm focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 w-4 h-4 transition-all duration-150"
                        />
                        <span class="ml-2">VAT applicable</span>
                      </label>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <label
                        for="recipe-yield-amount"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Yield Amount
                        <span class="text-gray-400">(optional)</span>
                      </label>
                      <input
                        id="recipe-yield-amount"
                        name="yieldAmount"
                        type="number"
                        min="0"
                        step="1"
                        placeholder="e.g., 1000"
                        class="block w-full px-4 py-2.5 text-gray-900 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                      <p class="mt-1.5 text-xs text-gray-500">
                        For sub-recipes only
                      </p>
                    </div>
                    <div>
                      <label
                        for="recipe-yield-unit"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Yield Unit <span class="text-gray-400">(optional)</span>
                      </label>
                      <input
                        id="recipe-yield-unit"
                        name="yieldUnit"
                        type="text"
                        placeholder="e.g., ml, g, portions"
                        class="block w-full px-4 py-2.5 text-gray-900 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                      <p class="mt-1.5 text-xs text-gray-500">
                        Unit of measurement
                      </p>
                    </div>
                  </div>

                  <div class="space-y-4">
                    <div class="flex items-center justify-between">
                      <h4 class="text-sm font-semibold text-gray-700">
                        Ingredients
                      </h4>
                      <button
                        type="button"
                        id="add-ingredient-row"
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-blue-300 text-sm font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 transition-colors duration-150"
                      >
                        <svg
                          class="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 4v16m8-8H4"
                          />
                        </svg>
                        Add Ingredient
                      </button>
                    </div>
                    <div id="recipe-ingredients-rows" class="space-y-3"></div>
                  </div>

                  <div class="flex items-center gap-3">
                    <button
                      type="submit"
                      class="inline-flex items-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 focus:outline-none"
                    >
                      Save Recipe
                    </button>
                    <button
                      type="button"
                      id="recipe-reset"
                      class="inline-flex items-center px-3 py-2 rounded-md border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-50"
                    >
                      Clear
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Margins View -->
          <div id="view-margins" class="view-content hidden space-y-6">
            <!-- Recipe List -->
            <div id="recipe-report-section">
              <div id="loading" class="text-center py-12">
                <div
                  class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"
                ></div>
                <p class="mt-4 text-gray-600">Loading recipes...</p>
              </div>

              <div id="recipe-list" class="hidden">
                <div
                  class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4"
                >
                  <div>
                    <h2 class="text-xl font-semibold text-gray-900">
                      All Recipes
                    </h2>
                    <p class="text-gray-600">
                      Click on a recipe to view detailed cost breakdown
                    </p>
                  </div>
                  <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2">
                      <label for="sort-recipes" class="text-sm text-gray-600"
                        >Sort by:</label
                      >
                      <select
                        id="sort-recipes"
                        class="px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      >
                        <option value="name-asc">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                        <option value="cost-asc">Cost (Low to High)</option>
                        <option value="cost-desc">Cost (High to Low)</option>
                        <option value="margin-asc">Margin (Low to High)</option>
                        <option value="margin-desc">
                          Margin (High to Low)
                        </option>
                      </select>
                    </div>
                    <button
                      type="button"
                      data-manager-switch="recipes"
                      class="inline-flex items-center px-4 py-2 rounded-md border border-blue-200 text-sm font-medium text-blue-600 hover:bg-blue-50"
                    >
                      + New Recipe
                    </button>
                  </div>
                </div>
                <div
                  id="recipes-container"
                  class="grid gap-4 md:grid-cols-2 lg:grid-cols-3"
                ></div>
              </div>
            </div>

            <!-- Recipe Detail View -->
            <div id="recipe-detail" class="hidden">
              <button
                id="back-btn"
                class="mb-4 text-blue-600 hover:text-blue-800 flex items-center"
              >
                <svg
                  class="w-5 h-5 mr-1"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 19l-7-7 7-7"
                  />
                </svg>
                Back to recipes
              </button>
              <div id="detail-container"></div>
            </div>
          </div>

          <!-- Settings View -->
          <div id="view-settings" class="view-content hidden space-y-6">
            <div class="max-w-2xl">
              <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-5 border-b border-gray-200">
                  <h2 class="text-xl font-semibold text-gray-900">
                    Configuration Settings
                  </h2>
                  <p class="mt-1 text-sm text-gray-600">
                    Manage system-wide settings for margin calculations and
                    pricing
                  </p>
                </div>

                <div id="settings-loading" class="px-6 py-12 text-center">
                  <div
                    class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"
                  ></div>
                  <p class="mt-4 text-gray-600">Loading settings...</p>
                </div>

                <form id="settings-form" class="hidden px-6 py-6 space-y-6">
                  <!-- VAT Rate -->
                  <div>
                    <label
                      for="setting-vat"
                      class="block text-sm font-medium text-gray-700 mb-2"
                    >
                      VAT Rate
                    </label>
                    <div class="flex items-center gap-3">
                      <input
                        type="number"
                        id="setting-vat"
                        name="vat"
                        step="0.01"
                        min="0"
                        max="1"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        required
                      />
                      <span class="text-sm text-gray-600 font-mono"
                        >√ó 100 =</span
                      >
                      <span
                        id="vat-percentage"
                        class="text-sm font-semibold text-gray-900 w-16"
                        >20%</span
                      >
                    </div>
                    <p class="mt-1 text-xs text-gray-500">
                      Enter as decimal (e.g., 0.2 for 20%, 0.175 for 17.5%)
                    </p>
                  </div>

                  <!-- Margin Target -->
                  <div>
                    <label
                      for="setting-margin"
                      class="block text-sm font-medium text-gray-700 mb-2"
                    >
                      Default Margin Target (%)
                    </label>
                    <input
                      type="number"
                      id="setting-margin"
                      name="marginTarget"
                      step="1"
                      min="0"
                      max="100"
                      class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      required
                    />
                    <p class="mt-1 text-xs text-gray-500">
                      Default target profit margin percentage for recipes
                    </p>
                  </div>

                  <!-- Default Price Includes VAT -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      Default Pricing Model
                    </label>
                    <div class="space-y-3">
                      <label
                        class="flex items-start p-4 border border-gray-300 rounded-md cursor-pointer hover:bg-gray-50"
                      >
                        <input
                          type="radio"
                          name="defaultPriceIncludesVat"
                          value="true"
                          class="mt-1 mr-3"
                          required
                        />
                        <div>
                          <div class="font-medium text-gray-900">
                            Prices include VAT/tax (UK/EU standard)
                          </div>
                          <div class="text-xs text-gray-600 mt-1">
                            Prices shown to customers already include VAT.
                            Example: ¬£6.00 includes VAT
                          </div>
                        </div>
                      </label>

                      <label
                        class="flex items-start p-4 border border-gray-300 rounded-md cursor-pointer hover:bg-gray-50"
                      >
                        <input
                          type="radio"
                          name="defaultPriceIncludesVat"
                          value="false"
                          class="mt-1 mr-3"
                        />
                        <div>
                          <div class="font-medium text-gray-900">
                            Prices exclude tax (US standard)
                          </div>
                          <div class="text-xs text-gray-600 mt-1">
                            Sales tax is added at point of sale. Example: $6.00
                            + tax
                          </div>
                        </div>
                      </label>
                    </div>
                    <p class="mt-2 text-xs text-gray-500">
                      This sets the default for new recipes. Individual recipes
                      can override this setting.
                    </p>
                  </div>

                  <!-- Form Actions -->
                  <div
                    class="flex items-center justify-between pt-4 border-t border-gray-200"
                  >
                    <div id="settings-save-status" class="text-sm"></div>
                    <button
                      type="submit"
                      class="inline-flex items-center px-6 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    >
                      Save Changes
                    </button>
                  </div>
                </form>
              </div>

              <!-- Database Backup Section -->
              <div class="bg-white shadow rounded-lg mt-6">
                <div class="px-6 py-5 border-b border-gray-200">
                  <h2 class="text-xl font-semibold text-gray-900">
                    Database Backup
                  </h2>
                  <p class="mt-1 text-sm text-gray-600">
                    Download a complete backup of your database
                  </p>
                </div>

                <div class="px-6 py-6">
                  <div
                    class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4"
                  >
                    <div class="flex items-start gap-3">
                      <svg
                        class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                      <div class="text-sm text-blue-800">
                        <p class="font-medium mb-1">
                          What's included in the backup?
                        </p>
                        <ul
                          class="list-disc list-inside space-y-1 text-blue-700"
                        >
                          <li>All suppliers, ingredients, and recipes</li>
                          <li>Cost calculations and margin data</li>
                          <li>Configuration settings</li>
                        </ul>
                        <p class="mt-2 text-xs">
                          The backup is a complete SQLite database file that can
                          be restored by replacing your current database file.
                        </p>
                      </div>
                    </div>
                  </div>

                  <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                      <p class="font-medium text-gray-900 mb-1">
                        Regular backups recommended
                      </p>
                      <p>
                        Keep your data safe by backing up regularly, especially
                        before making bulk changes.
                      </p>
                    </div>
                    <a
                      href="${API_BASE}/backup/database"
                      download
                      class="inline-flex items-center px-6 py-3 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors"
                      onclick="showToast('Database backup started...', 'success')"
                    >
                      <svg
                        class="w-5 h-5 mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                        />
                      </svg>
                      Download Backup
                    </a>
                  </div>
                </div>
              </div>

              <!-- Data Export Section -->
              <div class="bg-white shadow rounded-lg mt-6">
                <div class="px-6 py-5 border-b border-gray-200">
                  <h2 class="text-xl font-semibold text-gray-900">
                    Data Export
                  </h2>
                  <p class="mt-1 text-sm text-gray-600">
                    Export your data in various formats for analysis or
                    migration
                  </p>
                </div>

                <div class="px-6 py-6 space-y-6">
                  <!-- YAML Exports -->
                  <div>
                    <h3 class="text-sm font-semibold text-gray-900 mb-3">
                      Export as YAML
                    </h3>
                    <p class="text-xs text-gray-600 mb-4">
                      Export data in YAML format for version control, sharing,
                      or re-importing
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                      <a
                        href="${API_BASE}/export/suppliers"
                        download
                        class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        onclick="showToast('Exporting suppliers...', 'success')"
                      >
                        <svg
                          class="w-4 h-4 mr-2"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                          />
                        </svg>
                        All Suppliers
                      </a>
                      <a
                        href="${API_BASE}/export/ingredients"
                        download
                        class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        onclick="showToast('Exporting ingredients...', 'success')"
                      >
                        <svg
                          class="w-4 h-4 mr-2"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                          />
                        </svg>
                        All Ingredients
                      </a>
                      <a
                        href="${API_BASE}/export/recipes"
                        download
                        class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        onclick="showToast('Exporting recipes...', 'success')"
                      >
                        <svg
                          class="w-4 h-4 mr-2"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                          />
                        </svg>
                        All Recipes
                      </a>
                      <a
                        href="${API_BASE}/export/all"
                        download
                        class="inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        onclick="showToast('Exporting complete dataset...', 'success')"
                      >
                        <svg
                          class="w-4 h-4 mr-2"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                          />
                        </svg>
                        Complete Dataset (ZIP)
                      </a>
                    </div>
                  </div>

                  <!-- CSV Exports -->
                  <div class="pt-6 border-t border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3">
                      Export as CSV
                    </h3>
                    <p class="text-xs text-gray-600 mb-4">
                      Export data as CSV for spreadsheet analysis in Excel,
                      Google Sheets, etc.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                      <a
                        href="${API_BASE}/export/csv/suppliers"
                        download
                        class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                        onclick="showToast('Exporting suppliers CSV...', 'success')"
                      >
                        <svg
                          class="w-4 h-4 mr-2"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                          />
                        </svg>
                        Suppliers
                      </a>
                      <a
                        href="${API_BASE}/export/csv/ingredients"
                        download
                        class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                        onclick="showToast('Exporting ingredients CSV...', 'success')"
                      >
                        <svg
                          class="w-4 h-4 mr-2"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                          />
                        </svg>
                        Ingredients
                      </a>
                      <a
                        href="${API_BASE}/export/csv/recipes"
                        download
                        class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                        onclick="showToast('Exporting recipes CSV...', 'success')"
                      >
                        <svg
                          class="w-4 h-4 mr-2"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                          />
                        </svg>
                        Recipes
                      </a>
                      <a
                        href="${API_BASE}/export/csv/recipes-with-costs"
                        download
                        class="inline-flex items-center justify-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                        onclick="showToast('Calculating and exporting recipe costs...', 'success')"
                      >
                        <svg
                          class="w-4 h-4 mr-2"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                          />
                        </svg>
                        Recipes with Costs & Margins
                      </a>
                    </div>
                  </div>

                  <!-- Export Info -->
                  <div class="pt-6 border-t border-gray-200">
                    <div
                      class="bg-gray-50 border border-gray-200 rounded-lg p-4"
                    >
                      <div class="flex items-start gap-3">
                        <svg
                          class="w-5 h-5 text-gray-600 flex-shrink-0 mt-0.5"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                          />
                        </svg>
                        <div class="text-xs text-gray-700">
                          <p class="font-medium mb-2">Export Format Guide:</p>
                          <ul class="list-disc list-inside space-y-1">
                            <li>
                              <strong>YAML:</strong> Best for version control
                              and re-importing data
                            </li>
                            <li>
                              <strong>CSV:</strong> Best for spreadsheet
                              analysis and reporting
                            </li>
                            <li>
                              <strong>ZIP (Complete Dataset):</strong> Includes
                              all data organized in folders
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Help View -->
          <div id="view-help" class="view-content hidden">
            <div class="max-w-4xl mx-auto">
              <div class="bg-white shadow rounded-lg overflow-hidden">
                <!-- Help Header -->
                <div class="bg-blue-600 px-6 py-8 text-white">
                  <h1 class="text-3xl font-bold mb-2">
                    üìñ Menu Book Help & Documentation
                  </h1>
                  <p class="text-blue-100">
                    Everything you need to know about managing recipes and
                    margins
                  </p>
                </div>

                <!-- Help Content -->
                <div class="p-6 space-y-8">
                  <!-- Quick Start -->
                  <section id="help-quick-start">
                    <h2
                      class="text-2xl font-bold text-gray-900 mb-4 flex items-center"
                    >
                      <span
                        class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm font-bold"
                        >1</span
                      >
                      Quick Start Guide
                    </h2>
                    <div class="prose max-w-none">
                      <p class="text-gray-700 mb-4">
                        Follow these steps to get started with Menu Book:
                      </p>

                      <div class="space-y-4">
                        <div class="bg-gray-50 border-l-4 border-blue-500 p-4">
                          <h3 class="font-semibold text-gray-900 mb-2">
                            Step 1: Add Suppliers
                          </h3>
                          <p class="text-sm text-gray-700">
                            Go to <strong>Management ‚Üí Suppliers</strong> and
                            add your ingredient suppliers (e.g., wholesalers,
                            markets).
                          </p>
                        </div>

                        <div class="bg-gray-50 border-l-4 border-blue-500 p-4">
                          <h3 class="font-semibold text-gray-900 mb-2">
                            Step 2: Add Ingredients
                          </h3>
                          <p class="text-sm text-gray-700">
                            Navigate to
                            <strong>Management ‚Üí Ingredients</strong> and add
                            your ingredients with purchase costs, units, and
                            supplier information.
                          </p>
                        </div>

                        <div class="bg-gray-50 border-l-4 border-blue-500 p-4">
                          <h3 class="font-semibold text-gray-900 mb-2">
                            Step 3: Create Recipes
                          </h3>
                          <p class="text-sm text-gray-700">
                            Go to <strong>Management ‚Üí Recipes</strong> and
                            create your menu items by adding ingredients with
                            quantities.
                          </p>
                        </div>

                        <div class="bg-gray-50 border-l-4 border-blue-500 p-4">
                          <h3 class="font-semibold text-gray-900 mb-2">
                            Step 4: View Margins
                          </h3>
                          <p class="text-sm text-gray-700">
                            Click <strong>Margins</strong> in the sidebar to see
                            cost breakdowns and profit margins for all your
                            recipes.
                          </p>
                        </div>
                      </div>
                    </div>
                  </section>

                  <hr class="border-gray-200" />

                  <!-- Understanding Calculations -->
                  <section id="help-calculations">
                    <h2
                      class="text-2xl font-bold text-gray-900 mb-4 flex items-center"
                    >
                      <span
                        class="bg-green-100 text-green-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm font-bold"
                        >2</span
                      >
                      Understanding Margin Calculations
                    </h2>
                    <div class="prose max-w-none">
                      <p class="text-gray-700 mb-4">
                        Menu Book calculates profit margins using
                        industry-standard formulas:
                      </p>

                      <div
                        class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4"
                      >
                        <h3 class="font-semibold text-gray-900 mb-3">
                          Formula
                        </h3>
                        <div
                          class="font-mono text-sm bg-white p-3 rounded border border-blue-300"
                        >
                          <div class="mb-2">
                            <strong>Total Cost</strong> = Sum of all ingredient
                            costs (including sub-recipes)
                          </div>
                          <div class="mb-2">
                            <strong>Sell Price (ex-VAT)</strong> = Customer
                            price √∑ (1 + VAT rate)
                          </div>
                          <div class="mb-2">
                            <strong>Profit</strong> = Sell Price (ex-VAT) ‚àí
                            Total Cost
                          </div>
                          <div>
                            <strong>Margin %</strong> = (Profit √∑ Sell Price
                            (ex-VAT)) √ó 100
                          </div>
                        </div>
                      </div>

                      <div
                        class="bg-yellow-50 border-l-4 border-yellow-400 p-4"
                      >
                        <p class="text-sm text-gray-800">
                          <strong>üí° Tip:</strong> All margins are calculated
                          ex-VAT to give you accurate profit percentages before
                          tax.
                        </p>
                      </div>

                      <h3 class="font-semibold text-gray-900 mt-6 mb-3">
                        Example Calculation
                      </h3>
                      <div
                        class="bg-gray-50 p-4 rounded-lg space-y-2 text-sm font-mono"
                      >
                        <div>Customer Price: ¬£6.00 (includes VAT)</div>
                        <div>VAT Rate: 20% (0.2)</div>
                        <div>Sell Price (ex-VAT): ¬£6.00 √∑ 1.2 = ¬£5.00</div>
                        <div>Total Cost: ¬£2.00</div>
                        <div>Profit: ¬£5.00 ‚àí ¬£2.00 = ¬£3.00</div>
                        <div class="text-green-600 font-bold">
                          Margin: (¬£3.00 √∑ ¬£5.00) √ó 100 = 60%
                        </div>
                      </div>
                    </div>
                  </section>

                  <hr class="border-gray-200" />

                  <!-- VAT Handling -->
                  <section id="help-vat">
                    <h2
                      class="text-2xl font-bold text-gray-900 mb-4 flex items-center"
                    >
                      <span
                        class="bg-purple-100 text-purple-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm font-bold"
                        >3</span
                      >
                      VAT/Tax Handling
                    </h2>
                    <div class="prose max-w-none">
                      <p class="text-gray-700 mb-4">
                        Menu Book supports both UK/EU (VAT-inclusive) and US
                        (tax-exclusive) pricing models.
                      </p>

                      <h3 class="font-semibold text-gray-900 mb-3">
                        Configuration
                      </h3>
                      <p class="text-sm text-gray-700 mb-3">
                        Go to <strong>Settings</strong> to configure:
                      </p>
                      <ul
                        class="list-disc list-inside text-sm text-gray-700 space-y-1 mb-4"
                      >
                        <li>
                          <strong>VAT Rate:</strong> Your local tax rate (e.g.,
                          0.2 for 20%, 0.0625 for 6.25%)
                        </li>
                        <li>
                          <strong>Default Pricing Model:</strong> VAT-inclusive
                          (UK/EU) or tax-exclusive (US)
                        </li>
                      </ul>

                      <h3 class="font-semibold text-gray-900 mb-3">
                        Ingredient Purchase Costs
                      </h3>
                      <p class="text-sm text-gray-700 mb-3">
                        When adding ingredients, specify if the purchase cost
                        includes VAT:
                      </p>
                      <div class="bg-gray-50 p-4 rounded-lg space-y-2 text-sm">
                        <div>
                          ‚úÖ <strong>Includes VAT:</strong> The system will
                          strip VAT to calculate true cost
                        </div>
                        <div>
                          ‚ùå <strong>Excludes VAT:</strong> The purchase cost is
                          used as-is
                        </div>
                      </div>

                      <h3 class="font-semibold text-gray-900 mt-6 mb-3">
                        Recipe Pricing
                      </h3>
                      <div
                        class="bg-blue-50 border border-blue-200 rounded-lg p-4"
                      >
                        <p class="text-sm text-gray-800 mb-2">
                          <strong
                            >Default Setting (configurable in Settings):</strong
                          >
                        </p>
                        <div class="space-y-2 text-sm text-gray-700">
                          <div>
                            ‚Ä¢ <strong>UK/EU:</strong> Recipe prices include VAT
                            by default
                          </div>
                          <div>
                            ‚Ä¢ <strong>US:</strong> Recipe prices exclude tax by
                            default
                          </div>
                          <div
                            class="mt-3 pt-3 border-t border-blue-300 text-xs"
                          >
                            You can override this per-recipe in the YAML file
                            using
                            <code class="bg-white px-1 py-0.5 rounded"
                              >costing.vat: true/false</code
                            >
                          </div>
                        </div>
                      </div>
                    </div>
                  </section>

                  <hr class="border-gray-200" />

                  <!-- Sub-Recipes -->
                  <section id="help-subrecipes">
                    <h2
                      class="text-2xl font-bold text-gray-900 mb-4 flex items-center"
                    >
                      <span
                        class="bg-orange-100 text-orange-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm font-bold"
                        >4</span
                      >
                      Using Sub-Recipes
                    </h2>
                    <div class="prose max-w-none">
                      <p class="text-gray-700 mb-4">
                        Sub-recipes let you create reusable components (like
                        sauces or doughs) that can be used in multiple menu
                        items.
                      </p>

                      <h3 class="font-semibold text-gray-900 mb-3">
                        Creating Sub-Recipes
                      </h3>
                      <ol
                        class="list-decimal list-inside text-sm text-gray-700 space-y-2 mb-4"
                      >
                        <li>
                          Create a recipe with
                          <code class="bg-gray-100 px-2 py-0.5 rounded text-xs"
                            >class: sub_recipe</code
                          >
                        </li>
                        <li>
                          Specify the yield amount and unit (e.g., "1L" of
                          sauce)
                        </li>
                        <li>Add it as an ingredient to your main recipes</li>
                      </ol>

                      <div class="bg-green-50 border-l-4 border-green-400 p-4">
                        <p class="text-sm text-gray-800">
                          <strong>Example:</strong> Create "Pizza Sauce" with
                          yield "1L", then use "250ml" of it in your "Margherita
                          Pizza" recipe. The system automatically calculates the
                          cost as 25% of the sauce recipe's total cost.
                        </p>
                      </div>
                    </div>
                  </section>

                  <hr class="border-gray-200" />

                  <!-- Troubleshooting -->
                  <section id="help-troubleshooting">
                    <h2
                      class="text-2xl font-bold text-gray-900 mb-4 flex items-center"
                    >
                      <span
                        class="bg-red-100 text-red-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm font-bold"
                        >5</span
                      >
                      Troubleshooting
                    </h2>
                    <div class="prose max-w-none">
                      <div class="space-y-4">
                        <details
                          class="bg-gray-50 rounded-lg p-4 cursor-pointer"
                        >
                          <summary class="font-semibold text-gray-900">
                            Recipe shows "Error calculating cost"
                          </summary>
                          <div class="mt-3 text-sm text-gray-700 space-y-2">
                            <p><strong>Possible causes:</strong></p>
                            <ul class="list-disc list-inside ml-4">
                              <li>Missing ingredient in the database</li>
                              <li>Sub-recipe hasn't been created yet</li>
                              <li>
                                Circular dependency (Recipe A uses Recipe B,
                                which uses Recipe A)
                              </li>
                            </ul>
                            <p class="mt-2">
                              <strong>Solution:</strong> Ensure all ingredients
                              and sub-recipes exist before using them.
                            </p>
                          </div>
                        </details>

                        <details
                          class="bg-gray-50 rounded-lg p-4 cursor-pointer"
                        >
                          <summary class="font-semibold text-gray-900">
                            Margin calculation seems wrong
                          </summary>
                          <div class="mt-3 text-sm text-gray-700 space-y-2">
                            <p><strong>Check these settings:</strong></p>
                            <ul class="list-disc list-inside ml-4">
                              <li>VAT rate is correct in Settings</li>
                              <li>
                                Ingredient purchase costs have correct "Includes
                                VAT" setting
                              </li>
                              <li>
                                Recipe price has correct VAT setting (inclusive
                                vs exclusive)
                              </li>
                            </ul>
                            <p class="mt-2">
                              <strong>Remember:</strong> All margins are
                              calculated ex-VAT for accuracy.
                            </p>
                          </div>
                        </details>

                        <details
                          class="bg-gray-50 rounded-lg p-4 cursor-pointer"
                        >
                          <summary class="font-semibold text-gray-900">
                            Cannot add ingredients to recipe
                          </summary>
                          <div class="mt-3 text-sm text-gray-700 space-y-2">
                            <p><strong>Possible causes:</strong></p>
                            <ul class="list-disc list-inside ml-4">
                              <li>
                                No ingredients created yet - add ingredients
                                first
                              </li>
                              <li>Browser issue - try refreshing the page</li>
                            </ul>
                          </div>
                        </details>

                        <details
                          class="bg-gray-50 rounded-lg p-4 cursor-pointer"
                        >
                          <summary class="font-semibold text-gray-900">
                            Changes not saving
                          </summary>
                          <div class="mt-3 text-sm text-gray-700 space-y-2">
                            <p><strong>Try these steps:</strong></p>
                            <ol class="list-decimal list-inside ml-4 space-y-1">
                              <li>
                                Check for error messages at the top of the page
                              </li>
                              <li>Ensure all required fields are filled in</li>
                              <li>
                                Check the browser console for errors (F12 key)
                              </li>
                              <li>Refresh the page and try again</li>
                            </ol>
                          </div>
                        </details>
                      </div>
                    </div>
                  </section>

                  <hr class="border-gray-200" />

                  <!-- Additional Resources -->
                  <section id="help-resources">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">
                      Additional Resources
                    </h2>
                    <div
                      class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-6"
                    >
                      <h3 class="font-semibold text-gray-900 mb-3">
                        Need More Help?
                      </h3>
                      <div class="space-y-3 text-sm">
                        <div class="flex items-start gap-3">
                          <svg
                            class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                            />
                          </svg>
                          <div>
                            <strong class="text-gray-900"
                              >GitHub Repository:</strong
                            >
                            <p class="text-gray-600">
                              Report issues and contribute at
                              <a
                                href="https://github.com/harrytwright/margin-calculator/issues"
                                target="_blank"
                                class="text-blue-600 hover:underline"
                                >github.com/harrytwright/margin-calculator</a
                              >
                            </p>
                          </div>
                        </div>

                        <div class="flex items-start gap-3">
                          <svg
                            class="w-5 h-5 text-purple-600 flex-shrink-0 mt-0.5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
                            />
                          </svg>
                          <div>
                            <strong class="text-gray-900">Pro Tip:</strong>
                            <p class="text-gray-600">
                              Use YAML files to bulk import recipes and keep
                              them version-controlled with Git!
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </section>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script>
      const API_BASE = '/api'
      const state = {
        suppliers: [],
        ingredients: [],
        recipes: [],
        editing: {
          supplier: null,
          ingredient: null,
          recipe: null,
        },
        activeManager: 'suppliers',
        filters: {
          searchQuery: '',
          category: '',
          class: '',
          margin: '',
        },
      }

      // Modal functionality
      function openModal(title, formId) {
        const modal = document.getElementById('modal')
        const overlay = document.getElementById('modal-overlay')
        const modalBody = document.getElementById('modal-body')
        const modalTitle = document.getElementById('modal-title')
        const form = document.getElementById(formId)

        modalTitle.textContent = title

        // Move form into modal
        const formClone = form.cloneNode(true)
        formClone.classList.remove('hidden')
        formClone.id = `${formId}-active`
        modalBody.innerHTML = ''
        modalBody.appendChild(formClone)

        // Show modal with animation
        modal.classList.remove('hidden')
        overlay.classList.remove('hidden')

        setTimeout(() => {
          modal
            .querySelector('.modal-content')
            .classList.remove('scale-95', 'opacity-0')
          modal
            .querySelector('.modal-content')
            .classList.add('scale-100', 'opacity-100')
        }, 10)

        // Rebind form events for the cloned form
        if (formId === 'supplier-form') {
          formClone.addEventListener('submit', async (e) => {
            const success = await handleSupplierSubmit(e)
            if (success) closeModal()
          })
          formClone
            .querySelector('#supplier-reset')
            ?.addEventListener('click', clearSupplierForm)

          // Attach real-time validation
          const nameInput = formClone.querySelector('#supplier-name')
          nameInput?.addEventListener('input', () =>
            validateSupplierForm(formClone)
          )
          nameInput?.addEventListener('blur', () =>
            validateSupplierForm(formClone)
          )
          // Run validation once to set initial state
          setTimeout(() => validateSupplierForm(formClone), 10)
        } else if (formId === 'ingredient-form') {
          formClone.addEventListener('submit', async (e) => {
            const success = await handleIngredientSubmit(e)
            if (success) closeModal()
          })
          formClone
            .querySelector('#ingredient-reset')
            ?.addEventListener('click', clearIngredientForm)
          populateIngredientSelectors()

          // Attach real-time validation
          const fields = ['name', 'category', 'unit', 'cost']
          fields.forEach((field) => {
            const input = formClone.querySelector(`#ingredient-${field}`)
            input?.addEventListener('input', () =>
              validateIngredientForm(formClone)
            )
            input?.addEventListener('blur', () =>
              validateIngredientForm(formClone)
            )
          })
          // Run validation once to set initial state
          setTimeout(() => validateIngredientForm(formClone), 10)
        } else if (formId === 'recipe-form') {
          formClone.addEventListener('submit', async (e) => {
            const success = await handleRecipeSubmit(e)
            if (success) closeModal()
          })
          formClone
            .querySelector('#recipe-reset')
            ?.addEventListener('click', clearRecipeForm)
          formClone
            .querySelector('#add-ingredient-row')
            ?.addEventListener('click', () =>
              addIngredientRow(
                formClone.querySelector('#recipe-ingredients-rows')
              )
            )
          // Initialize with one ingredient row
          const ingredientRows = formClone.querySelector(
            '#recipe-ingredients-rows'
          )
          if (ingredientRows.children.length === 0) {
            addIngredientRow(ingredientRows)
          }
          populateIngredientSelectors()
        }

        // Focus first input
        setTimeout(() => {
          const firstInput = formClone.querySelector(
            'input:not([type="checkbox"]), select, textarea'
          )
          firstInput?.focus()
        }, 100)
      }

      function closeModal() {
        const modal = document.getElementById('modal')
        const overlay = document.getElementById('modal-overlay')
        const modalContent = modal.querySelector('.modal-content')

        // Animate out
        modalContent.classList.remove('scale-100', 'opacity-100')
        modalContent.classList.add('scale-95', 'opacity-0')

        setTimeout(() => {
          modal.classList.add('hidden')
          overlay.classList.add('hidden')
          document.getElementById('modal-body').innerHTML = ''
        }, 200)
      }

      function bindSortDropdown() {
        const sortSelect = document.getElementById('sort-recipes')
        if (sortSelect) {
          sortSelect.addEventListener('change', () => {
            loadRecipeReport()
          })
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        bindNavigation()
        bindSearchAndFilters()
        bindManagerNavigation()
        bindForms()
        bindModalTriggers()
        bindSortDropdown()
        loadManagementData()
        loadRecipeReport()
        startEventStream()
      })

      async function fetchJSON(pathname, options) {
        try {
          const response = await fetch(`${API_BASE}${pathname}`, options)
          if (!response.ok) {
            const contentType = response.headers.get('content-type')
            if (contentType && contentType.includes('application/json')) {
              const errorData = await response.json()
              // Create custom error with parsed details
              const error = new Error(errorData.error || response.statusText)
              error.validationErrors = errorData.details || []
              error.statusCode = response.status
              throw error
            } else {
              const payload = await response.text()
              const error = new Error(payload || response.statusText)
              error.statusCode = response.status
              throw error
            }
          }
          const text = await response.text()
          return text ? JSON.parse(text) : null
        } catch (error) {
          // Handle network errors
          if (error instanceof TypeError && error.message.includes('fetch')) {
            const networkError = new Error(
              'Unable to connect to the server. Please check your connection.'
            )
            networkError.isNetworkError = true
            throw networkError
          }
          // Re-throw API errors
          throw error
        }
      }

      async function sendJSON(pathname, method, payload) {
        return fetchJSON(pathname, {
          method,
          headers: {
            'content-type': 'application/json',
          },
          body: JSON.stringify(payload),
        })
      }

      // Real-time validation
      function validateIngredientForm(form) {
        const fields = {
          name: form.querySelector('#ingredient-name'),
          category: form.querySelector('#ingredient-category'),
          unit: form.querySelector('#ingredient-unit'),
          cost: form.querySelector('#ingredient-cost'),
        }

        const icons = {
          name: form.querySelector('#ingredient-name-valid'),
          category: form.querySelector('#ingredient-category-valid'),
          unit: form.querySelector('#ingredient-unit-valid'),
          cost: form.querySelector('#ingredient-cost-valid'),
        }

        const submitBtn = form.querySelector('#ingredient-submit-btn')

        // Validate name
        const nameValid = fields.name.value.trim().length >= 2
        if (nameValid) {
          icons.name.classList.remove('hidden')
          fields.name.classList.add('border-green-300')
          fields.name.classList.remove('border-red-300')
        } else if (fields.name.value.trim().length > 0) {
          icons.name.classList.add('hidden')
          fields.name.classList.add('border-red-300')
          fields.name.classList.remove('border-green-300')
        } else {
          icons.name.classList.add('hidden')
          fields.name.classList.remove('border-red-300', 'border-green-300')
        }

        // Validate category
        const categoryValid = fields.category.value.trim().length >= 2
        if (categoryValid) {
          icons.category.classList.remove('hidden')
          fields.category.classList.add('border-green-300')
        } else {
          icons.category.classList.add('hidden')
          fields.category.classList.remove('border-green-300')
        }

        // Validate unit
        const unitValid = fields.unit.value.trim().length >= 1
        if (unitValid) {
          icons.unit.classList.remove('hidden')
          fields.unit.classList.add('border-green-300')
        } else {
          icons.unit.classList.add('hidden')
          fields.unit.classList.remove('border-green-300')
        }

        // Validate cost
        const cost = parseFloat(fields.cost.value)
        const costValid = !isNaN(cost) && cost > 0
        if (costValid) {
          icons.cost.classList.remove('hidden')
          fields.cost.classList.add('border-green-300')
        } else {
          icons.cost.classList.add('hidden')
          fields.cost.classList.remove('border-green-300')
        }

        // Enable submit only if all required fields valid
        const allValid = nameValid && categoryValid && unitValid && costValid
        submitBtn.disabled = !allValid
      }

      function validateSupplierForm(form) {
        const nameInput = form.querySelector('#supplier-name')
        const submitBtn = form.querySelector('#supplier-submit-btn')
        const validIcon = form.querySelector('#supplier-name-valid')
        const errorIcon = form.querySelector('#supplier-name-error')
        const errorMsg = form.querySelector('#supplier-name-error-msg')
        const hint = form.querySelector('#supplier-name-hint')

        const name = nameInput.value.trim()
        let isValid = false

        if (name.length === 0) {
          // Empty - show neither icon
          validIcon.classList.add('hidden')
          errorIcon.classList.add('hidden')
          errorMsg.classList.add('hidden')
          hint.classList.remove('hidden')
          nameInput.classList.remove('border-red-300', 'border-green-300')
        } else if (name.length < 2) {
          // Too short
          validIcon.classList.add('hidden')
          errorIcon.classList.remove('hidden')
          errorMsg.textContent = 'Name must be at least 2 characters'
          errorMsg.classList.remove('hidden')
          hint.classList.add('hidden')
          nameInput.classList.add('border-red-300')
          nameInput.classList.remove('border-green-300')
        } else {
          // Valid
          validIcon.classList.remove('hidden')
          errorIcon.classList.add('hidden')
          errorMsg.classList.add('hidden')
          hint.classList.add('hidden')
          nameInput.classList.add('border-green-300')
          nameInput.classList.remove('border-red-300')
          isValid = true
        }

        // Enable/disable submit button
        submitBtn.disabled = !isValid
      }

      function bindModalTriggers() {
        // New entity buttons
        document
          .getElementById('new-supplier-btn')
          ?.addEventListener('click', () => {
            clearSupplierForm()
            openModal('New Supplier', 'supplier-form')
          })

        document
          .getElementById('new-ingredient-btn')
          ?.addEventListener('click', () => {
            clearIngredientForm()
            openModal('New Ingredient', 'ingredient-form')
          })

        document
          .getElementById('new-recipe-btn')
          ?.addEventListener('click', () => {
            clearRecipeForm()
            openModal('New Recipe', 'recipe-form')
          })

        // Modal close button
        document
          .getElementById('modal-close')
          ?.addEventListener('click', closeModal)

        // Backdrop click
        document
          .getElementById('modal-overlay')
          ?.addEventListener('click', closeModal)

        // ESC key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            const modal = document.getElementById('modal')
            if (!modal.classList.contains('hidden')) {
              closeModal()
            }
          }
        })
      }

      // View Navigation
      function switchView(viewName) {
        // Hide all views
        document.querySelectorAll('.view-content').forEach((view) => {
          view.classList.add('hidden')
        })

        // Show selected view
        const targetView = document.getElementById(`view-${viewName}`)
        if (targetView) {
          targetView.classList.remove('hidden')
        }

        // Update header title
        const titles = {
          dashboard: 'Dashboard',
          suppliers: 'Suppliers',
          ingredients: 'Ingredients',
          recipes: 'Recipes',
          margins: 'Margins',
          settings: 'Settings',
          help: 'Help & Documentation',
        }
        document.getElementById('view-title').textContent =
          titles[viewName] || viewName

        // Update nav link active states
        document.querySelectorAll('.nav-link').forEach((link) => {
          const isActive = link.dataset.view === viewName
          link.classList.toggle('bg-blue-600', isActive)
          link.classList.toggle('text-white', isActive)
          link.classList.toggle('text-gray-700', !isActive)
          link.classList.toggle('text-gray-600', !isActive)
          link.classList.toggle('hover:bg-gray-100', !isActive)
          link.classList.toggle('hover:bg-blue-700', isActive)
        })

        // Show/hide search & filters based on view
        const searchFilters = document.getElementById('search-filters')
        const showSearch = [
          'suppliers',
          'ingredients',
          'recipes',
          'margins',
        ].includes(viewName)
        searchFilters.classList.toggle('hidden', !showSearch)
        searchFilters.classList.toggle('flex', showSearch)

        // Configure filters for current view
        configureFiltersForView(viewName)

        // Reset filters when switching views
        resetFilters()

        // Show/hide manager panels for management views
        if (['suppliers', 'ingredients', 'recipes'].includes(viewName)) {
          setActiveManager(viewName)
        }

        // Load data for specific views
        if (viewName === 'dashboard') {
          loadDashboardStats()
        } else if (viewName === 'margins') {
          loadMargins()
        } else if (viewName === 'settings') {
          loadSettings()
        }
      }

      async function loadDashboardStats() {
        // Update dashboard statistics
        document.getElementById('stat-total-recipes').textContent =
          state.recipes.length
        document.getElementById('stat-total-ingredients').textContent =
          state.ingredients.length

        // Load and render charts
        await renderDashboardCharts()
      }

      async function renderDashboardCharts() {
        try {
          // Fetch margin data from /api/report
          const results = await fetchJSON('/report')

          // Filter out failed calculations
          const successfulRecipes = results.filter((r) => r.success)

          if (successfulRecipes.length === 0) {
            // Update stats with zeros
            document.getElementById('stat-avg-margin').textContent = '0%'
            document.getElementById('stat-below-target').textContent = '0'
            return
          }

          // Calculate stats for summary cards
          const avgMargin =
            successfulRecipes.reduce(
              (sum, r) => sum + r.margin.actualMargin,
              0
            ) / successfulRecipes.length
          const belowTarget = successfulRecipes.filter(
            (r) => !r.margin.meetsTarget
          ).length

          document.getElementById('stat-avg-margin').textContent =
            avgMargin.toFixed(1) + '%'
          document.getElementById('stat-below-target').textContent = belowTarget

          // Render Margin Distribution Chart
          renderMarginDistributionChart(successfulRecipes)

          // Render Top 5 Most Profitable Chart
          renderTopPerformersChart(successfulRecipes)

          // Render Category Breakdown Chart
          renderCategoryBreakdownChart(successfulRecipes)
        } catch (error) {
          console.error('Error rendering charts:', error)
          showToast(
            'Unable to render dashboard charts. Data may be incomplete.',
            'error'
          )
        }
      }

      function renderMarginDistributionChart(recipes) {
        const ctx = document.getElementById('margin-distribution-chart')
        if (!ctx) return

        // Group recipes by margin ranges
        const ranges = {
          '0-30%': recipes.filter((r) => r.margin.actualMargin < 30).length,
          '30-50%': recipes.filter(
            (r) => r.margin.actualMargin >= 30 && r.margin.actualMargin < 50
          ).length,
          '50-70%': recipes.filter(
            (r) => r.margin.actualMargin >= 50 && r.margin.actualMargin < 70
          ).length,
          '70%+': recipes.filter((r) => r.margin.actualMargin >= 70).length,
        }

        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(ranges),
            datasets: [
              {
                label: 'Number of Recipes',
                data: Object.values(ranges),
                backgroundColor: [
                  'rgba(239, 68, 68, 0.8)', // red for low margins
                  'rgba(251, 146, 60, 0.8)', // orange
                  'rgba(34, 197, 94, 0.8)', // green
                  'rgba(59, 130, 246, 0.8)', // blue for high margins
                ],
                borderColor: [
                  'rgb(239, 68, 68)',
                  'rgb(251, 146, 60)',
                  'rgb(34, 197, 94)',
                  'rgb(59, 130, 246)',
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                },
              },
            },
          },
        })
      }

      function renderTopPerformersChart(recipes) {
        const ctx = document.getElementById('top-performers-chart')
        if (!ctx) return

        // Sort by profit and take top 5
        const topRecipes = recipes
          .sort((a, b) => b.margin.profit - a.margin.profit)
          .slice(0, 5)

        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: topRecipes.map((r) => r.name),
            datasets: [
              {
                label: 'Profit (¬£)',
                data: topRecipes.map((r) => (r.margin.profit / 100).toFixed(2)),
                backgroundColor: 'rgba(34, 197, 94, 0.8)',
                borderColor: 'rgb(34, 197, 94)',
                borderWidth: 1,
              },
            ],
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              x: {
                beginAtZero: true,
              },
            },
          },
        })
      }

      function renderCategoryBreakdownChart(recipes) {
        const ctx = document.getElementById('category-breakdown-chart')
        if (!ctx) return

        // Group by category
        const categoryCount = {}
        recipes.forEach((r) => {
          const recipe = state.recipes.find((sr) => sr.slug === r.slug)
          const category = recipe?.category || 'Uncategorized'
          categoryCount[category] = (categoryCount[category] || 0) + 1
        })

        const categories = Object.keys(categoryCount)
        const colors = [
          'rgba(59, 130, 246, 0.8)',
          'rgba(139, 92, 246, 0.8)',
          'rgba(236, 72, 153, 0.8)',
          'rgba(251, 146, 60, 0.8)',
          'rgba(34, 197, 94, 0.8)',
          'rgba(14, 165, 233, 0.8)',
        ]

        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: categories,
            datasets: [
              {
                data: Object.values(categoryCount),
                backgroundColor: colors.slice(0, categories.length),
                borderColor: colors
                  .slice(0, categories.length)
                  .map((c) => c.replace('0.8', '1')),
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
              },
            },
          },
        })
      }

      function loadMargins() {
        // The existing loadRecipes() function will be called
        if (state.recipes.length === 0) {
          loadRecipes()
        }
      }

      // Search & Filter Functions
      function configureFiltersForView(viewName) {
        // Hide all filter groups
        document.getElementById('filter-category-group').classList.add('hidden')
        document.getElementById('filter-class-group').classList.add('hidden')
        document.getElementById('filter-margin-group').classList.add('hidden')

        // Show relevant filters for each view
        if (viewName === 'ingredients' || viewName === 'recipes') {
          document
            .getElementById('filter-category-group')
            .classList.remove('hidden')
        }
        if (viewName === 'recipes') {
          document
            .getElementById('filter-class-group')
            .classList.remove('hidden')
        }
        if (viewName === 'margins') {
          document
            .getElementById('filter-margin-group')
            .classList.remove('hidden')
        }

        // Update search placeholder
        const searchInput = document.getElementById('search-input')
        const placeholders = {
          suppliers: 'Search suppliers...',
          ingredients: 'Search ingredients...',
          recipes: 'Search recipes...',
          margins: 'Search recipes...',
        }
        searchInput.placeholder = placeholders[viewName] || 'Search...'
      }

      function resetFilters() {
        state.filters.searchQuery = ''
        state.filters.category = ''
        state.filters.class = ''
        state.filters.margin = ''

        document.getElementById('search-input').value = ''
        document.getElementById('filter-category').value = ''
        document.getElementById('filter-class').value = ''
        document.getElementById('filter-margin').value = ''

        updateFilterCount()
        applyFilters()
      }

      function updateFilterCount() {
        const count =
          (state.filters.searchQuery ? 1 : 0) +
          (state.filters.category ? 1 : 0) +
          (state.filters.class ? 1 : 0) +
          (state.filters.margin ? 1 : 0)

        const countBadge = document.getElementById('filter-count')
        if (count > 0) {
          countBadge.textContent = count
          countBadge.classList.remove('hidden')
        } else {
          countBadge.classList.add('hidden')
        }
      }

      function applyFilters() {
        // Determine current view
        const activeView = Array.from(
          document.querySelectorAll('.view-content')
        ).find((el) => !el.classList.contains('hidden'))

        if (!activeView) return

        const viewId = activeView.id.replace('view-', '')

        // Apply filters based on view
        if (viewId === 'suppliers') {
          filterSuppliers()
        } else if (viewId === 'ingredients') {
          filterIngredients()
        } else if (viewId === 'recipes') {
          filterRecipes()
        } else if (viewId === 'margins') {
          // Margins view uses same data as recipes
          filterRecipes()
        }
      }

      function filterSuppliers() {
        const query = state.filters.searchQuery.toLowerCase()
        const list = document.getElementById('supplier-list')
        const cards = list.querySelectorAll('[data-supplier-slug]')

        cards.forEach((card) => {
          const name = card.querySelector('h4')?.textContent.toLowerCase() || ''
          const matches = !query || name.includes(query)
          card.style.display = matches ? '' : 'none'
        })
      }

      function filterIngredients() {
        const query = state.filters.searchQuery.toLowerCase()
        const category = state.filters.category
        const list = document.getElementById('ingredient-list')
        const cards = list.querySelectorAll('[data-ingredient-slug]')

        cards.forEach((card) => {
          const name = card.querySelector('h4')?.textContent.toLowerCase() || ''
          const cardCategory = card.dataset.ingredientCategory || ''

          const matchesSearch = !query || name.includes(query)
          const matchesCategory = !category || cardCategory === category
          const matches = matchesSearch && matchesCategory

          card.style.display = matches ? '' : 'none'
        })
      }

      function filterRecipes() {
        const query = state.filters.searchQuery.toLowerCase()
        const category = state.filters.category
        const recipeClass = state.filters.class

        // Filter both recipes in management view and margins view
        const containers = ['recipes-container', 'recipe-manager-list']

        containers.forEach((containerId) => {
          const list = document.getElementById(containerId)
          if (!list) return

          const cards = list.querySelectorAll('[data-recipe-slug]')

          cards.forEach((card) => {
            // Check both h3 (margins view) and h4 (management view) for recipe name
            const h3 = card.querySelector('h3')?.textContent.toLowerCase() || ''
            const h4 = card.querySelector('h4')?.textContent.toLowerCase() || ''
            const name = h4 || h3
            const cardCategory = card.dataset.recipeCategory || ''
            const cardClass = card.dataset.recipeClass || ''

            const matchesSearch = !query || name.includes(query)
            const matchesCategory = !category || cardCategory === category
            const matchesClass = !recipeClass || cardClass === recipeClass
            const matches = matchesSearch && matchesCategory && matchesClass

            card.style.display = matches ? '' : 'none'
          })
        })
      }

      function toggleManagementSubmenu() {
        const subnav = document.getElementById('management-subnav')
        const chevron = document.getElementById('management-chevron')
        const isHidden = subnav.classList.contains('hidden')

        if (isHidden) {
          subnav.classList.remove('hidden')
          chevron.classList.add('rotate-180')
        } else {
          subnav.classList.add('hidden')
          chevron.classList.remove('rotate-180')
        }
      }

      function bindSearchAndFilters() {
        // Search input with debouncing
        let searchTimeout
        const searchInput = document.getElementById('search-input')
        searchInput.addEventListener('input', (e) => {
          clearTimeout(searchTimeout)
          searchTimeout = setTimeout(() => {
            state.filters.searchQuery = e.target.value
            updateFilterCount()
            applyFilters()
          }, 300) // 300ms debounce
        })

        // Filter dropdown toggle
        const filterToggle = document.getElementById('filter-toggle')
        const filterMenu = document.getElementById('filter-menu')

        filterToggle.addEventListener('click', (e) => {
          e.stopPropagation()
          filterMenu.classList.toggle('hidden')
        })

        // Close filter menu when clicking outside
        document.addEventListener('click', (e) => {
          if (
            !filterMenu.contains(e.target) &&
            !filterToggle.contains(e.target)
          ) {
            filterMenu.classList.add('hidden')
          }
        })

        // Filter change handlers
        document
          .getElementById('filter-category')
          .addEventListener('change', (e) => {
            state.filters.category = e.target.value
            updateFilterCount()
            applyFilters()
          })

        document
          .getElementById('filter-class')
          .addEventListener('change', (e) => {
            state.filters.class = e.target.value
            updateFilterCount()
            applyFilters()
          })

        document
          .getElementById('filter-margin')
          .addEventListener('change', (e) => {
            state.filters.margin = e.target.value
            updateFilterCount()
            applyFilters()
          })

        // Clear filters button
        document
          .getElementById('clear-filters')
          .addEventListener('click', () => {
            resetFilters()
            filterMenu.classList.add('hidden')
          })
      }

      function bindNavigation() {
        // Sidebar navigation links
        document.querySelectorAll('[data-view]').forEach((link) => {
          link.addEventListener('click', (e) => {
            e.preventDefault()
            switchView(link.dataset.view)

            // Auto-expand management submenu if clicking on management items
            if (
              ['suppliers', 'ingredients', 'recipes'].includes(
                link.dataset.view
              )
            ) {
              const subnav = document.getElementById('management-subnav')
              if (subnav.classList.contains('hidden')) {
                toggleManagementSubmenu()
              }
            }
          })
        })

        // Management toggle button
        document
          .getElementById('management-toggle')
          .addEventListener('click', toggleManagementSubmenu)

        // Quick action buttons on dashboard
        document.querySelectorAll('.nav-action').forEach((btn) => {
          btn.addEventListener('click', () => {
            switchView(btn.dataset.view)
          })
        })
      }

      function bindManagerNavigation() {
        document
          .querySelectorAll('.manager-tab')
          .forEach((button) =>
            button.addEventListener('click', () =>
              setActiveManager(button.dataset.manager)
            )
          )

        document.querySelectorAll('[data-manager-switch]').forEach((button) =>
          button.addEventListener('click', () => {
            const manager = button.dataset.managerSwitch
            switchView(manager) // Switch to the management view
            setActiveManager(manager) // Set the active manager tab
          })
        )
      }

      function setActiveManager(key) {
        state.activeManager = key

        document.querySelectorAll('.manager-tab').forEach((button) => {
          const isActive = button.dataset.manager === key
          button.classList.toggle('bg-blue-600', isActive)
          button.classList.toggle('text-white', isActive)
          button.classList.toggle('border', !isActive)
          button.classList.toggle('border-blue-200', !isActive)
          button.classList.toggle('text-blue-600', !isActive)
          button.setAttribute('aria-selected', String(isActive))
        })

        document.querySelectorAll('.manager-panel').forEach((panel) => {
          panel.classList.add('hidden')
        })

        const activePanel = document.getElementById(`manager-${key}`)
        if (activePanel) {
          activePanel.classList.remove('hidden')
        }
      }

      function bindForms() {
        document
          .getElementById('supplier-form')
          .addEventListener('submit', handleSupplierSubmit)

        document
          .getElementById('supplier-reset')
          .addEventListener('click', clearSupplierForm)

        document
          .getElementById('ingredient-form')
          .addEventListener('submit', handleIngredientSubmit)

        document
          .getElementById('ingredient-reset')
          .addEventListener('click', clearIngredientForm)

        document
          .getElementById('recipe-form')
          .addEventListener('submit', handleRecipeSubmit)

        document
          .getElementById('recipe-reset')
          .addEventListener('click', clearRecipeForm)

        document
          .getElementById('add-ingredient-row')
          .addEventListener('click', () =>
            addIngredientRow(document.getElementById('recipe-ingredients-rows'))
          )

        const ingredientContainer = document.getElementById(
          'recipe-ingredients-rows'
        )
        if (ingredientContainer && ingredientContainer.children.length === 0) {
          addIngredientRow(ingredientContainer)
        }
      }

      /**
       * Show a toast notification
       * @param {string} message - The message to display
       * @param {'success'|'error'|'info'} type - The type of toast
       * @param {number} duration - Auto-dismiss duration in ms (0 = no auto-dismiss)
       */
      function showToast(message, type = 'info', duration = 4000) {
        const container = document.getElementById('toast-container')
        const toast = document.createElement('div')
        toast.className =
          'pointer-events-auto flex items-start gap-3 max-w-sm w-full bg-white rounded-lg shadow-lg border px-4 py-3 transform transition-all duration-300 translate-x-full opacity-0'

        // Icon based on type
        let icon = ''
        let borderColor = 'border-gray-200'
        let iconColor = 'text-gray-500'

        if (type === 'success') {
          borderColor = 'border-green-400'
          iconColor = 'text-green-500'
          icon = `
            <svg class="w-5 h-5 flex-shrink-0 ${iconColor}" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
          `
        } else if (type === 'error') {
          borderColor = 'border-red-400'
          iconColor = 'text-red-500'
          icon = `
            <svg class="w-5 h-5 flex-shrink-0 ${iconColor}" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
          `
        } else {
          borderColor = 'border-blue-400'
          iconColor = 'text-blue-500'
          icon = `
            <svg class="w-5 h-5 flex-shrink-0 ${iconColor}" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
          `
        }

        toast.classList.add(borderColor)

        toast.innerHTML = `
          ${icon}
          <p class="flex-1 text-sm text-gray-900">${message}</p>
          <button class="toast-close flex-shrink-0 text-gray-400 hover:text-gray-600 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        `

        container.appendChild(toast)

        // Animate in
        setTimeout(() => {
          toast.classList.remove('translate-x-full', 'opacity-0')
          toast.classList.add('translate-x-0', 'opacity-100')
        }, 10)

        // Remove toast function
        const removeToast = () => {
          toast.classList.add('translate-x-full', 'opacity-0')
          setTimeout(() => {
            toast.remove()
          }, 300)
        }

        // Close button handler
        toast
          .querySelector('.toast-close')
          .addEventListener('click', removeToast)

        // Auto-dismiss
        if (duration > 0) {
          setTimeout(removeToast, duration)
        }
      }

      // Keep old function for backward compatibility during migration
      function setFeedback(elementId, message, tone = 'info') {
        showToast(message, tone)
      }

      /**
       * Display validation errors inline below form fields
       */
      function showValidationErrors(form, errors) {
        // Clear any existing error messages
        form.querySelectorAll('.validation-error').forEach((el) => el.remove())
        form.querySelectorAll('.border-red-300').forEach((el) => {
          el.classList.remove('border-red-300')
        })

        errors.forEach((error) => {
          // Map API field names to form input IDs
          const fieldMapping = {
            supplier: 'ingredient-supplier, recipe-supplier',
            'purchase.cost': 'ingredient-cost',
            'costing.price': 'recipe-price',
            'costing.margin': 'recipe-margin',
            name: 'supplier-name, ingredient-name, recipe-name',
            category: 'ingredient-category, recipe-category',
            ingredients: 'recipe-ingredients-rows',
          }

          const possibleIds = fieldMapping[error.field] || error.field
          const ids = possibleIds.split(', ')

          for (const id of ids) {
            const input = form.querySelector(`#${id}`)
            if (input) {
              // Add red border and shake animation
              input.classList.add('border-red-300', 'border-2')
              input.classList.add('ring-2', 'ring-red-100')

              // Create error message element with icon
              const errorEl = document.createElement('div')
              errorEl.className =
                'validation-error flex items-start gap-2 text-red-600 text-sm mt-2 p-2 bg-red-50 rounded-lg border border-red-200'
              errorEl.innerHTML = `
                <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <span>${error.message}</span>
              `

              // Insert after the input or its parent wrapper
              const parent = input.parentElement
              parent.insertBefore(errorEl, input.nextSibling)

              // Add shake animation
              input.style.animation = 'shake 0.4s'
              setTimeout(() => {
                input.style.animation = ''
              }, 400)

              break
            }
          }
        })
      }

      /**
       * Clear all validation errors from a form
       */
      function clearValidationErrors(form) {
        form.querySelectorAll('.validation-error').forEach((el) => el.remove())
        form.querySelectorAll('.border-red-300').forEach((el) => {
          el.classList.remove(
            'border-red-300',
            'border-2',
            'ring-2',
            'ring-red-100'
          )
        })
      }

      /**
       * Show delete confirmation modal
       * @param {string} entityType - Type of entity (e.g., 'Supplier', 'Ingredient', 'Recipe')
       * @param {string} entityName - Name of the entity to delete
       * @param {string} message - Warning message
       * @param {Function} onConfirm - Callback when delete is confirmed
       * @returns {Promise<boolean>} - Resolves to true if confirmed, false if cancelled
       */
      function showDeleteModal(entityType, entityName, message, onConfirm) {
        return new Promise((resolve) => {
          const modal = document.getElementById('delete-modal')
          const overlay = document.getElementById('delete-modal-overlay')
          const content = modal.querySelector('.delete-modal-content')
          const entityTypeEl = document.getElementById('delete-entity-type')
          const messageEl = document.getElementById('delete-message')
          const cancelBtn = document.getElementById('delete-cancel-btn')
          const confirmBtn = document.getElementById('delete-confirm-btn')

          // Set content
          entityTypeEl.textContent = entityType
          messageEl.textContent = message

          // Show modal with animation
          modal.classList.remove('hidden')
          overlay.classList.remove('hidden')
          setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0')
            content.classList.add('scale-100', 'opacity-100')
          }, 10)

          // Close function
          const closeModal = () => {
            content.classList.remove('scale-100', 'opacity-100')
            content.classList.add('scale-95', 'opacity-0')
            setTimeout(() => {
              modal.classList.add('hidden')
              overlay.classList.add('hidden')
              cancelBtn.removeEventListener('click', handleCancel)
              confirmBtn.removeEventListener('click', handleConfirm)
              overlay.removeEventListener('click', handleCancel)
            }, 200)
          }

          // Handlers
          const handleCancel = () => {
            closeModal()
            resolve(false)
          }

          const handleConfirm = async () => {
            setButtonLoading(confirmBtn, true)
            try {
              await onConfirm()
              closeModal()
              resolve(true)
            } catch (error) {
              showToast(error.message, 'error')
              resolve(false)
            } finally {
              setButtonLoading(confirmBtn, false)
            }
          }

          // Event listeners
          cancelBtn.addEventListener('click', handleCancel)
          confirmBtn.addEventListener('click', handleConfirm)
          overlay.addEventListener('click', handleCancel)

          // ESC key handler
          const handleEsc = (e) => {
            if (e.key === 'Escape') {
              handleCancel()
              document.removeEventListener('keydown', handleEsc)
            }
          }
          document.addEventListener('keydown', handleEsc)
        })
      }

      /**
       * Set loading state on a button
       * @param {HTMLButtonElement} button - The button element
       * @param {boolean} loading - Whether to show loading state
       */
      function setButtonLoading(button, loading) {
        if (loading) {
          button.disabled = true
          button.dataset.originalText = button.innerHTML
          button.innerHTML = `
            <svg class="animate-spin h-4 w-4 text-white inline-block" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="ml-2">Saving...</span>
          `
        } else {
          button.disabled = false
          if (button.dataset.originalText) {
            button.innerHTML = button.dataset.originalText
            delete button.dataset.originalText
          }
        }
      }

      async function loadManagementData() {
        try {
          const [suppliers, ingredients, recipes] = await Promise.all([
            fetchJSON('/suppliers'),
            fetchJSON('/ingredients'),
            fetchJSON('/recipes'),
          ])

          state.suppliers = suppliers || []
          state.ingredients = ingredients || []
          state.recipes = recipes || []

          renderSupplierList()
          renderIngredientList()
          renderRecipeManagerList()
          populateIngredientSelectors()
        } catch (error) {
          console.error('Failed to load management data', error)
          showToast(
            'Unable to load management data. Please refresh the page.',
            'error'
          )
        }
      }

      function renderSupplierList() {
        const container = document.getElementById('supplier-list')
        if (!container) return

        if (state.suppliers.length === 0) {
          container.innerHTML = `
            <div class="col-span-full text-sm text-gray-500">
              No suppliers yet. Use the form above to add one.
            </div>
          `
          return
        }

        container.innerHTML = state.suppliers
          .map(
            (supplier) => `
            <div class="border border-gray-200 rounded-lg p-4 bg-white"
                 data-supplier-slug="${supplier.slug}">
              <h4 class="text-sm font-semibold text-gray-900">${supplier.name}</h4>
              <p class="text-xs text-gray-500 mt-1">slug: ${supplier.slug}</p>
              <div class="mt-3 flex gap-2">
                <button
                  type="button"
                  class="px-3 py-1.5 text-xs rounded-md border border-gray-300 text-gray-600 bg-gray-50"
                  data-action="edit-supplier"
                  data-slug="${supplier.slug}"
                >
                  Edit
                </button>
                <button
                  type="button"
                  class="px-3 py-1.5 text-xs rounded-md border border-gray-200 text-red-600 bg-red-50"
                  data-action="delete-supplier"
                  data-slug="${supplier.slug}"
                >
                  Delete
                </button>
              </div>
            </div>
          `
          )
          .join('')

        container
          .querySelectorAll('[data-action="edit-supplier"]')
          .forEach((button) =>
            button.addEventListener('click', () =>
              startEditSupplier(button.dataset.slug)
            )
          )

        container
          .querySelectorAll('[data-action="delete-supplier"]')
          .forEach((button) =>
            button.addEventListener('click', () =>
              handleDeleteSupplier(button.dataset.slug)
            )
          )
      }

      function renderIngredientList() {
        const container = document.getElementById('ingredient-list')
        if (!container) return

        if (state.ingredients.length === 0) {
          container.innerHTML = `
            <div class="col-span-full text-sm text-gray-500">
              No ingredients yet. Use the form above to add one.
            </div>
          `
          return
        }

        container.innerHTML = state.ingredients
          .map(
            (ingredient) => `
            <div class="border border-gray-200 rounded-lg p-4 bg-white"
                 data-ingredient-slug="${ingredient.slug}"
                 data-ingredient-category="${ingredient.category || ''}">
              <h4 class="text-sm font-semibold text-gray-900">${ingredient.name}</h4>
              <p class="text-xs text-gray-500">Category: ${
                ingredient.category || '‚Äî'
              }</p>
              <p class="text-xs text-gray-500">Supplier: ${
                ingredient.supplierSlug || 'generic'
              }</p>
              <div class="mt-3 flex gap-2">
                <button
                  type="button"
                  class="px-3 py-1.5 text-xs rounded-md border border-gray-300 text-gray-600 bg-gray-50"
                  data-action="edit-ingredient"
                  data-slug="${ingredient.slug}"
                >
                  Edit
                </button>
                <button
                  type="button"
                  class="px-3 py-1.5 text-xs rounded-md border border-gray-200 text-red-600 bg-red-50"
                  data-action="delete-ingredient"
                  data-slug="${ingredient.slug}"
                >
                  Delete
                </button>
              </div>
            </div>
          `
          )
          .join('')

        container
          .querySelectorAll('[data-action="edit-ingredient"]')
          .forEach((button) =>
            button.addEventListener('click', () =>
              startEditIngredient(button.dataset.slug)
            )
          )

        container
          .querySelectorAll('[data-action="delete-ingredient"]')
          .forEach((button) =>
            button.addEventListener('click', () =>
              handleDeleteIngredient(button.dataset.slug)
            )
          )
      }

      function renderRecipeManagerList() {
        const container = document.getElementById('recipe-manager-list')
        if (!container) return

        if (state.recipes.length === 0) {
          container.innerHTML = `
            <div class="col-span-full text-sm text-gray-500">
              No recipes yet. Use the form above to add one.
            </div>
          `
          return
        }

        container.innerHTML = state.recipes
          .map(
            (recipe) => `
            <div class="border border-gray-200 rounded-lg p-4 bg-white"
                 data-recipe-slug="${recipe.slug}"
                 data-recipe-category="${recipe.category || ''}"
                 data-recipe-class="${recipe.class || ''}">
              <h4 class="text-sm font-semibold text-gray-900">${recipe.name}</h4>
              <p class="text-xs text-gray-500">Slug: ${recipe.slug}</p>
              <div class="mt-3 flex gap-2">
                <button
                  type="button"
                  class="px-3 py-1.5 text-xs rounded-md border border-gray-300 text-gray-600 bg-gray-50 hover:bg-gray-100"
                  data-action="edit-recipe"
                  data-slug="${recipe.slug}"
                >
                  Edit
                </button>
                <button
                  type="button"
                  class="px-3 py-1.5 text-xs rounded-md border border-gray-300 text-blue-600 bg-blue-50 hover:bg-blue-100"
                  data-action="duplicate-recipe"
                  data-slug="${recipe.slug}"
                >
                  Duplicate
                </button>
                <button
                  type="button"
                  class="px-3 py-1.5 text-xs rounded-md border border-gray-200 text-red-600 bg-red-50 hover:bg-red-100"
                  data-action="delete-recipe"
                  data-slug="${recipe.slug}"
                >
                  Delete
                </button>
              </div>
            </div>
          `
          )
          .join('')

        container
          .querySelectorAll('[data-action="edit-recipe"]')
          .forEach((button) =>
            button.addEventListener('click', () =>
              startEditRecipe(button.dataset.slug)
            )
          )

        container
          .querySelectorAll('[data-action="duplicate-recipe"]')
          .forEach((button) =>
            button.addEventListener('click', () =>
              handleDuplicateRecipe(button.dataset.slug)
            )
          )

        container
          .querySelectorAll('[data-action="delete-recipe"]')
          .forEach((button) =>
            button.addEventListener('click', () =>
              handleDeleteRecipe(button.dataset.slug)
            )
          )
      }

      function startEditSupplier(slug) {
        const supplier = state.suppliers.find((item) => item.slug === slug)
        if (!supplier) return

        setActiveManager('suppliers')

        // Populate original form with data
        document.getElementById('supplier-name').value = supplier.name
        document.querySelector(
          '#supplier-form button[type="submit"]'
        ).textContent = 'Update Supplier'
        state.editing.supplier = slug

        // Open modal with populated form
        openModal(`Edit Supplier: ${supplier.name}`, 'supplier-form')
      }

      async function startEditIngredient(slug) {
        setActiveManager('ingredients')
        try {
          const ingredient = await fetchJSON(`/ingredients/${slug}`)
          if (!ingredient) return

          document.getElementById('ingredient-name').value = ingredient.name
          document.getElementById('ingredient-category').value =
            ingredient.category || ''
          document.getElementById('ingredient-unit').value =
            ingredient.purchase.unit || ''
          document.getElementById('ingredient-cost').value =
            ingredient.purchase.cost || 0
          document.getElementById('ingredient-vat').checked =
            !!ingredient.purchase.vat
          populateIngredientSelectors()
          document.getElementById('ingredient-supplier').value =
            ingredient.supplierSlug || ''
          // Disable supplier select when editing (immutable field)
          document.getElementById('ingredient-supplier').disabled = true
          document
            .getElementById('ingredient-supplier-help')
            .classList.remove('hidden')
          document.getElementById('ingredient-conversion').value =
            ingredient.conversionRate || ''
          document.getElementById('ingredient-notes').value =
            ingredient.notes || ''

          document.querySelector(
            '#ingredient-form button[type="submit"]'
          ).textContent = 'Update Ingredient'
          state.editing.ingredient = slug

          // Open modal with populated form
          openModal(`Edit Ingredient: ${ingredient.name}`, 'ingredient-form')
        } catch (error) {
          showToast(`Unable to load ingredient: ${error.message}`, 'error')
        }
      }

      async function startEditRecipe(slug) {
        setActiveManager('recipes')
        try {
          const recipe = await fetchJSON(`/recipes/${slug}`)
          if (!recipe) return

          document.getElementById('recipe-name').value = recipe.name
          document.getElementById('recipe-category').value =
            recipe.category || ''
          document.getElementById('recipe-stage').value =
            recipe.stage || 'development'
          document.getElementById('recipe-class').value =
            recipe.class || 'menu_item'
          document.getElementById('recipe-parent').value = recipe.parent || ''
          document.getElementById('recipe-price').value = recipe.sellPrice || 0
          document.getElementById('recipe-margin').value =
            recipe.targetMargin || ''
          document.getElementById('recipe-vat').checked = !!recipe.includesVat
          document.getElementById('recipe-yield-amount').value =
            recipe.yieldAmount || ''
          document.getElementById('recipe-yield-unit').value =
            recipe.yieldUnit || ''

          const ingredients = Array.isArray(recipe.ingredients)
            ? recipe.ingredients
            : JSON.parse(recipe.ingredients || '[]')

          document.querySelector(
            '#recipe-form button[type="submit"]'
          ).textContent = 'Update Recipe'
          state.editing.recipe = slug

          // Store ingredients for after modal opens
          const ingredientsToPopulate = ingredients

          // Open modal first
          openModal(`Edit Recipe: ${recipe.name}`, 'recipe-form')

          // Now populate ingredients in the ACTIVE (cloned) form
          setTimeout(() => {
            const activeForm = document.getElementById('recipe-form-active')
            const container = activeForm.querySelector(
              '[id="recipe-ingredients-rows"]'
            )
            container.innerHTML = ''

            if (ingredientsToPopulate.length > 0) {
              ingredientsToPopulate.forEach((item) =>
                addIngredientRow(
                  container,
                  {
                    type: item.type || 'ingredient',
                    slug: item.slug,
                    unit: item.unit || item.with?.unit || '',
                  },
                  true // Skip populate for each row
                )
              )
            } else {
              addIngredientRow(container)
            }

            // Populate all selectors once after all rows are added
            populateIngredientSelectors()

            // Now set the slug values after options are populated
            container.querySelectorAll('.ingredient-row').forEach((row) => {
              const pendingSlug = row.getAttribute('data-pending-slug')
              if (pendingSlug) {
                row.querySelector('.ingredient-slug').value = pendingSlug
                row.removeAttribute('data-pending-slug')
              }
            })
          }, 50) // Wait for modal to finish opening and cloning
        } catch (error) {
          showToast(`Unable to load recipe: ${error.message}`, 'error')
        }
      }

      function clearSupplierForm() {
        document.getElementById('supplier-form').reset()
        state.editing.supplier = null
        document.querySelector(
          '#supplier-form button[type="submit"]'
        ).textContent = 'Save Supplier'
      }

      function clearIngredientForm() {
        document.getElementById('ingredient-form').reset()
        // Re-enable supplier select for new ingredients
        document.getElementById('ingredient-supplier').disabled = false
        document
          .getElementById('ingredient-supplier-help')
          .classList.add('hidden')
        state.editing.ingredient = null
        document.querySelector(
          '#ingredient-form button[type="submit"]'
        ).textContent = 'Save Ingredient'
      }

      function clearRecipeForm() {
        document.getElementById('recipe-form').reset()
        state.editing.recipe = null
        const rows = document.getElementById('recipe-ingredients-rows')
        rows.innerHTML = ''
        addIngredientRow(rows)
        populateIngredientSelectors()
        document.querySelector(
          '#recipe-form button[type="submit"]'
        ).textContent = 'Save Recipe'
      }

      async function handleSupplierSubmit(event) {
        event.preventDefault()
        const form = event.target
        const submitButton = form.querySelector('button[type="submit"]')

        // Clear previous validation errors
        clearValidationErrors(form)

        const name = form.name.value.trim()

        if (!name) {
          showToast('Supplier name is required', 'error')
          return false
        }

        const slug = state.editing.supplier
        const payload = { name }

        setButtonLoading(submitButton, true)

        try {
          if (slug) {
            await sendJSON(`/suppliers/${slug}`, 'PUT', payload)
            clearSupplierForm()
            showToast(`Supplier "${name}" updated successfully`, 'success')
          } else {
            await sendJSON('/suppliers', 'POST', payload)
            clearSupplierForm()
            showToast(`Supplier "${name}" created successfully`, 'success')
          }

          await loadManagementData()
          await loadRecipeReport()
          return true
        } catch (error) {
          // Check if this is a validation error
          if (error.validationErrors && error.validationErrors.length > 0) {
            showValidationErrors(form, error.validationErrors)
            showToast('Please fix the validation errors below', 'error')
          } else if (error.isNetworkError) {
            showToast(
              'Network error: Unable to save supplier. Please check your connection.',
              'error'
            )
          } else if (error.statusCode === 409) {
            showToast('A supplier with this name already exists', 'error')
          } else {
            showToast(`Failed to save supplier: ${error.message}`, 'error')
          }
          return false
        } finally {
          setButtonLoading(submitButton, false)
        }
      }

      async function handleIngredientSubmit(event) {
        event.preventDefault()
        const form = event.target
        const submitButton = form.querySelector('button[type="submit"]')

        // Clear previous validation errors
        clearValidationErrors(form)

        const name = form.name.value.trim()
        const category = form.category.value.trim()
        const unit = form.purchaseUnit.value.trim()
        const costValue = form.purchaseCost.value
        const supplierSlug = form.supplier.value
        const conversionRate = form.conversionRate.value.trim()
        const notes = form.notes.value.trim()
        const vat = form.purchaseVat.checked

        const cost = parseFloat(costValue)
        if (!name || !category || !unit || Number.isNaN(cost)) {
          showToast('Please complete all required fields', 'error')
          return false
        }

        const payload = {
          name,
          category,
          purchase: {
            unit,
            cost,
            vat,
          },
          supplier: supplierSlug ? { uses: `slug:${supplierSlug}` } : undefined,
          conversionRate: conversionRate || undefined,
          notes: notes || undefined,
        }

        const slug = state.editing.ingredient
        setButtonLoading(submitButton, true)

        try {
          if (slug) {
            await sendJSON(`/ingredients/${slug}`, 'PUT', payload)
            clearIngredientForm()
            showToast(`Ingredient "${name}" updated successfully`, 'success')
          } else {
            await sendJSON('/ingredients', 'POST', payload)
            clearIngredientForm()
            showToast(`Ingredient "${name}" created successfully`, 'success')
          }

          await loadManagementData()
          await loadRecipeReport()
          return true
        } catch (error) {
          // Check if this is a validation error
          if (error.validationErrors && error.validationErrors.length > 0) {
            showValidationErrors(form, error.validationErrors)
            showToast('Please fix the validation errors below', 'error')
          } else if (error.isNetworkError) {
            showToast(
              'Network error: Unable to save ingredient. Please check your connection.',
              'error'
            )
          } else if (error.statusCode === 409) {
            showToast('An ingredient with this name already exists', 'error')
          } else if (
            error.statusCode === 404 &&
            error.message.includes('Supplier')
          ) {
            showToast(
              'Selected supplier not found. Please choose a different supplier.',
              'error'
            )
          } else {
            showToast(`Failed to save ingredient: ${error.message}`, 'error')
          }
          return false
        } finally {
          setButtonLoading(submitButton, false)
        }
      }

      async function handleRecipeSubmit(event) {
        event.preventDefault()
        const form = event.target
        const submitButton = form.querySelector('button[type="submit"]')

        // Clear previous validation errors
        clearValidationErrors(form)

        const name = form.name.value.trim()
        const category = form.category.value.trim()
        const stage = form.stage.value
        const recipeClass = form.class.value
        const parent = form.extends.value
        const priceValue = form.price.value
        const marginValue = form.margin.value
        const vat = form.vat.checked
        const yieldAmountValue = form.yieldAmount.value
        const yieldUnit = form.yieldUnit.value.trim()

        const price = Number(priceValue)
        if (!name || Number.isNaN(price)) {
          showToast('Recipe name and price are required', 'error')
          return false
        }

        const ingredients = collectIngredientRows(form)
          .filter((row) => row.slug && row.unit)
          .map((row) => ({
            type: row.type,
            uses: `slug:${row.slug}`,
            with: { unit: row.unit },
          }))

        const payload = {
          name,
          category: category || undefined,
          stage,
          class: recipeClass,
          costing: {
            price,
            margin: marginValue ? Number(marginValue) : undefined,
            vat,
          },
          ingredients,
          yieldAmount: yieldAmountValue ? Number(yieldAmountValue) : undefined,
          yieldUnit: yieldUnit || undefined,
        }

        if (parent) {
          payload.extends = `slug:${parent}`
        }

        const slug = state.editing.recipe
        setButtonLoading(submitButton, true)

        try {
          if (slug) {
            await sendJSON(`/recipes/${slug}`, 'PUT', payload)
            clearRecipeForm()
            showToast(`Recipe "${name}" updated successfully`, 'success')
          } else {
            await sendJSON(`/recipes`, 'POST', payload)
            clearRecipeForm()
            showToast(`Recipe "${name}" created successfully`, 'success')
          }

          await loadManagementData()
          await loadRecipeReport()
          return true
        } catch (error) {
          // Check if this is a validation error
          if (error.validationErrors && error.validationErrors.length > 0) {
            showValidationErrors(form, error.validationErrors)
            showToast('Please fix the validation errors below', 'error')
          } else if (error.isNetworkError) {
            showToast(
              'Network error: Unable to save recipe. Please check your connection.',
              'error'
            )
          } else if (error.statusCode === 409) {
            showToast('A recipe with this name already exists', 'error')
          } else if (
            error.statusCode === 404 &&
            error.message.includes('ingredient')
          ) {
            showToast(
              'One or more selected ingredients not found. Please review your ingredients.',
              'error'
            )
          } else if (ingredients.length === 0) {
            showToast('Recipe must have at least one ingredient', 'error')
          } else {
            showToast(`Failed to save recipe: ${error.message}`, 'error')
          }
          return false
        } finally {
          setButtonLoading(submitButton, false)
        }
      }

      async function handleDeleteSupplier(slug) {
        // Count ingredients using this supplier
        const usageCount = state.ingredients.filter(
          (ing) => ing.supplierSlug === slug
        ).length

        const warningMsg =
          usageCount > 0
            ? `‚ö†Ô∏è This supplier is used by ${usageCount} ingredient${usageCount > 1 ? 's' : ''}. Are you sure you want to delete supplier "${slug}"? This action cannot be undone.`
            : `Are you sure you want to delete supplier "${slug}"? This action cannot be undone.`

        await showDeleteModal('Supplier', slug, warningMsg, async () => {
          await fetchJSON(`/suppliers/${slug}`, { method: 'DELETE' })
          if (state.editing.supplier === slug) {
            clearSupplierForm()
          }
          showToast(`Supplier "${slug}" deleted successfully`, 'success')
          await loadManagementData()
          await loadRecipeReport()
        })
      }

      async function handleDeleteIngredient(slug) {
        // Count recipes using this ingredient
        const usageCount = state.recipes.filter((recipe) => {
          return recipe.ingredients?.some(
            (ing) => ing.slug === slug && ing.type === 'ingredient'
          )
        }).length

        const warningMsg =
          usageCount > 0
            ? `‚ö†Ô∏è This ingredient is used in ${usageCount} recipe${usageCount > 1 ? 's' : ''}. Are you sure you want to delete ingredient "${slug}"? This action cannot be undone.`
            : `Are you sure you want to delete ingredient "${slug}"? This action cannot be undone.`

        await showDeleteModal('Ingredient', slug, warningMsg, async () => {
          await fetchJSON(`/ingredients/${slug}`, { method: 'DELETE' })
          if (state.editing.ingredient === slug) {
            clearIngredientForm()
          }
          showToast(`Ingredient "${slug}" deleted successfully`, 'success')
          await loadManagementData()
          await loadRecipeReport()
        })
      }

      async function handleDuplicateRecipe(slug) {
        setActiveManager('recipes')
        try {
          const recipe = await fetchJSON(`/recipes/${slug}`)
          if (!recipe) return

          // Clear editing state to create new recipe
          state.editing.recipe = null

          // Pre-fill form with recipe data
          document.getElementById('recipe-name').value = `${recipe.name} (Copy)`
          document.getElementById('recipe-category').value =
            recipe.category || ''
          document.getElementById('recipe-class').value =
            recipe.class || 'menu_item'
          document.getElementById('recipe-price').value =
            recipe.sellPrice / 100 || 0
          document.getElementById('recipe-margin').value =
            recipe.targetMargin || 25
          document.getElementById('recipe-vat').checked = !!recipe.includesVat

          // Clear and repopulate ingredients
          const ingredientsContainer = document.getElementById(
            'recipe-ingredients-rows'
          )
          ingredientsContainer.innerHTML = ''

          if (recipe.ingredients && recipe.ingredients.length > 0) {
            recipe.ingredients.forEach((ing) => {
              addIngredientRow(
                ingredientsContainer,
                {
                  type: ing.type || 'ingredient',
                  slug: ing.slug,
                  amount: ing.amount,
                  unit: ing.unit,
                },
                true // Skip populate for each row
              )
            })
          } else {
            addIngredientRow(ingredientsContainer)
          }

          // Populate all selectors once after all rows are added
          populateIngredientSelectors()

          // Now set the slug values after options are populated
          ingredientsContainer
            .querySelectorAll('.ingredient-row')
            .forEach((row) => {
              const pendingSlug = row.getAttribute('data-pending-slug')
              if (pendingSlug) {
                row.querySelector('.ingredient-slug').value = pendingSlug
                row.removeAttribute('data-pending-slug')
              }
            })

          document.querySelector(
            '#recipe-form button[type="submit"]'
          ).textContent = 'Save Recipe'

          // Open modal
          openModal(`Duplicate Recipe: ${recipe.name}`, 'recipe-form')
        } catch (error) {
          showToast(`Unable to duplicate recipe: ${error.message}`, 'error')
        }
      }

      async function handleDeleteRecipe(slug) {
        await showDeleteModal(
          'Recipe',
          slug,
          `Are you sure you want to delete recipe "${slug}"? This action cannot be undone.`,
          async () => {
            await fetchJSON(`/recipes/${slug}`, { method: 'DELETE' })
            if (state.editing.recipe === slug) {
              clearRecipeForm()
            }
            showToast(`Recipe "${slug}" deleted successfully`, 'success')
            await loadManagementData()
            await loadRecipeReport()
          }
        )
      }

      function addIngredientRow(container, initial, skipPopulate = false) {
        const row = document.createElement('div')
        row.className =
          'ingredient-row overflow-y-scroll flex flex-col md:flex-row md:items-center gap-3 border border-gray-200 rounded-lg p-4 bg-white shadow-sm hover:shadow-md transition-shadow duration-150'
        row.innerHTML = `
          <div class="flex-1 flex flex-col sm:flex-row gap-3">
            <select class="ingredient-type px-4 py-2.5 text-gray-900 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-150">
              <option value="ingredient">ü•ï Ingredient</option>
              <option value="recipe">üìã Recipe</option>
            </select>
            <select class="ingredient-slug flex-1 px-4 py-2.5 text-gray-900 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-150">
              <option value="">-- Select --</option>
            </select>
            <input
              type="text"
              class="ingredient-unit w-full sm:w-32 px-4 py-2.5 text-gray-900 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-150"
              placeholder="e.g., 50g, 100ml"
            />
          </div>
          <button
            type="button"
            class="remove-ingredient-row inline-flex items-center justify-center px-4 py-2.5 text-sm font-medium rounded-lg border border-red-300 text-red-600 bg-red-50 hover:bg-red-100 transition-colors duration-150"
          >
            Remove
          </button>
        `

        container.appendChild(row)

        const typeSelect = row.querySelector('.ingredient-type')
        typeSelect.addEventListener('change', () =>
          populateIngredientSelectors()
        )

        row
          .querySelector('.remove-ingredient-row')
          .addEventListener('click', () => {
            if (container.children.length > 1) {
              row.remove()
            }
          })

        if (initial) {
          typeSelect.value = initial.type || 'ingredient'
          row.querySelector('.ingredient-unit').value = initial.unit || ''

          // Store slug on row element for later if we're skipping populate
          if (initial.slug) {
            if (skipPopulate) {
              row.setAttribute('data-pending-slug', initial.slug)
            } else {
              row.querySelector('.ingredient-slug').value = initial.slug
            }
          }
        }

        // Only populate if not skipped (allows batch operations to populate once after all rows added)
        if (!skipPopulate) {
          populateIngredientSelectors()

          // If we just populated, set the slug value now
          if (initial && initial.slug) {
            row.querySelector('.ingredient-slug').value = initial.slug
          }
        }
      }

      function collectIngredientRows(form) {
        const container = form || document
        return Array.from(
          container.querySelectorAll('#recipe-ingredients-rows .ingredient-row')
        ).map((row) => ({
          type: row.querySelector('.ingredient-type').value,
          slug: row.querySelector('.ingredient-slug').value,
          unit: row.querySelector('.ingredient-unit').value,
        }))
      }

      function populateIngredientSelectors() {
        const ingredientOptions = state.ingredients
          .map((ing) => `<option value="${ing.slug}">${ing.name}</option>`)
          .join('')

        const recipeOptions = state.recipes
          .map((rec) => `<option value="${rec.slug}">${rec.name}</option>`)
          .join('')

        document
          .querySelectorAll('#recipe-ingredients-rows .ingredient-row')
          .forEach((row) => {
            const typeSelect = row.querySelector('.ingredient-type')
            const slugSelect = row.querySelector('.ingredient-slug')
            const current = slugSelect.value
            if (typeSelect.value === 'recipe') {
              slugSelect.innerHTML = `<option value="">-- Select --</option>${recipeOptions}`
            } else {
              slugSelect.innerHTML = `<option value="">-- Select --</option>${ingredientOptions}`
            }
            slugSelect.value = current
          })

        const supplierSelect = document.getElementById('ingredient-supplier')
        if (supplierSelect) {
          supplierSelect.innerHTML = state.suppliers
            .map(
              (supplier) =>
                `<option value="${supplier.slug}">${supplier.name}</option>`
            )
            .join('')
        }

        const parentSelect = document.getElementById('recipe-parent')
        if (parentSelect) {
          const preserve = parentSelect.value
          parentSelect.innerHTML =
            '<option value="">-- None --</option>' +
            state.recipes
              .map(
                (recipe) =>
                  `<option value="${recipe.slug}">${recipe.name}</option>`
              )
              .join('')
          parentSelect.value = preserve
        }
      }

      function startEventStream() {
        if (!window.EventSource) {
          console.warn('EventSource not supported in this browser')
          return
        }

        const source = new EventSource(`${API_BASE}/events`)

        source.addEventListener('entity', (event) => {
          try {
            JSON.parse(event.data)
            loadManagementData()
            loadRecipeReport()
          } catch (error) {
            console.error('Failed to parse event payload', error)
            showToast(
              'Live update failed. Please refresh to see latest changes.',
              'error'
            )
          }
        })

        source.addEventListener('error', () => {
          source.close()
          setTimeout(startEventStream, 5000)
        })
      }

      function sortRecipes(recipes, sortValue) {
        const sorted = [...recipes]
        const [field, direction] = sortValue.split('-')

        sorted.sort((a, b) => {
          let aVal, bVal

          if (field === 'name') {
            aVal = (a.name || a.slug || '').toLowerCase()
            bVal = (b.name || b.slug || '').toLowerCase()
          } else if (field === 'cost') {
            aVal = a.cost || 0
            bVal = b.cost || 0
          } else if (field === 'margin') {
            aVal = a.margin?.actualMargin || 0
            bVal = b.margin?.actualMargin || 0
          }

          if (aVal < bVal) return direction === 'asc' ? -1 : 1
          if (aVal > bVal) return direction === 'asc' ? 1 : -1
          return 0
        })

        return sorted
      }

      async function loadRecipeReport() {
        try {
          let recipes = await fetchJSON('/report')

          // Sort recipes based on selected option
          const sortSelect = document.getElementById('sort-recipes')
          const sortValue = sortSelect ? sortSelect.value : 'name-asc'
          recipes = sortRecipes(recipes, sortValue)

          document.getElementById('loading').classList.add('hidden')
          document.getElementById('recipe-list').classList.remove('hidden')

          const container = document.getElementById('recipes-container')

          // Show empty state if no recipes
          if (recipes.length === 0) {
            container.innerHTML = `
              <div class="col-span-full text-center py-12">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No recipes yet</h3>
                <p class="mt-1 text-sm text-gray-500">Get started by creating a recipe in the Management section.</p>
                <div class="mt-6">
                  <button
                    type="button"
                    class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"
                    onclick="switchView('recipes'); setActiveManager('recipes')"
                  >
                    <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Add Your First Recipe
                  </button>
                </div>
              </div>
            `
            return
          }

          container.innerHTML = recipes
            .map((recipe) => {
              if (!recipe.success) {
                return `
                  <div class="bg-red-50 border border-red-200 rounded-lg p-4"
                       data-recipe-slug="${recipe.slug}"
                       data-recipe-category=""
                       data-recipe-class="">
                    <h3 class="font-semibold text-red-900">${recipe.slug}</h3>
                    <p class="text-sm text-red-600 mt-1">Error: ${recipe.error}</p>
                  </div>
                `
              }

              const marginColor = recipe.margin.meetsTarget ? 'green' : 'red'
              const marginIcon = recipe.margin.meetsTarget ? '‚úì' : '‚úó'

              return `
                <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow cursor-pointer"
                     data-recipe-slug="${recipe.slug}"
                     data-recipe-category="${recipe.category || ''}"
                     data-recipe-class="${recipe.class || ''}"
                     onclick="loadRecipeDetail('${recipe.slug}')">
                  <h3 class="font-semibold text-gray-900 text-lg mb-2">${recipe.name}</h3>
                  <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                      <span class="text-gray-600">Cost:</span>
                      <span class="font-medium">¬£${recipe.cost.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600">Sell Price:</span>
                      <span class="font-medium">¬£${recipe.margin.sellPrice.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t">
                      <span class="text-gray-600">Margin:</span>
                      <span class="font-semibold text-${marginColor}-600">
                        ${marginIcon} ${recipe.margin.actualMargin.toFixed(1)}%
                      </span>
                    </div>
                    <div class="text-xs text-gray-500">Target: ${recipe.margin.targetMargin}%</div>
                  </div>
                </div>
              `
            })
            .join('')
        } catch (error) {
          document.getElementById('loading').innerHTML = `
            <div class="text-red-600">
              <p class="font-semibold">Error loading recipes</p>
              <p class="text-sm mt-2">${error.message}</p>
            </div>
          `
        }
      }

      async function loadRecipeDetail(slug) {
        try {
          document.getElementById('recipe-list').classList.add('hidden')
          document.getElementById('recipe-detail').classList.remove('hidden')

          const data = await fetchJSON(`/recipes/${slug}/calculate`)

          const container = document.getElementById('detail-container')
          const marginColor = data.margin.meetsTarget ? 'green' : 'red'

          container.innerHTML = `
            <div class="bg-white border border-gray-200 rounded-lg p-6">
              <div class="flex justify-between items-start mb-4">
                <h2 class="text-2xl font-bold text-gray-900">${data.recipe.name}</h2>
                <div class="flex gap-2">
                  <a
                    href="${API_BASE}/export/recipe/${slug}"
                    download="${slug}.yaml"
                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                  >
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Export YAML
                  </a>
                  <button
                    onclick="switchView('recipes'); setActiveManager('recipes'); startEditRecipe('${slug}')"
                    class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    Edit Recipe
                  </button>
                </div>
              </div>
              <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Cost Breakdown</h3>
                <div class="bg-gray-50 rounded-lg p-4">
                  ${renderCostTree(data.cost.breakdown)}
                  <div class="mt-4 pt-4 border-t border-gray-300">
                    <div class="flex justify-between text-lg font-semibold">
                      <span>Total Cost:</span>
                      <span>¬£${data.cost.total.toFixed(2)}</span>
                    </div>
                  </div>
                </div>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Pricing & Margin</h3>
                <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                  <div class="flex justify-between">
                    <span class="text-gray-600">Sell Price (ex-VAT):</span>
                    <span class="font-medium">¬£${data.margin.sellPrice.toFixed(2)}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Customer Price:</span>
                    <span class="font-medium">¬£${data.margin.customerPrice.toFixed(2)}</span>
                  </div>
                  ${
                    data.margin.vatApplicable
                      ? `
                        <div class="flex justify-between text-sm text-gray-500">
                          <span>VAT:</span>
                          <span>¬£${data.margin.vatAmount.toFixed(2)}</span>
                        </div>
                      `
                      : '<div class="text-sm text-gray-500">VAT not applicable</div>'
                  }
                  <div class="flex justify-between pt-3 border-t">
                    <span class="text-gray-600">Profit:</span>
                    <span class="font-medium text-green-600">¬£${data.margin.profit.toFixed(2)}</span>
                  </div>
                  <div class="flex justify-between items-center pt-3 border-t">
                    <span class="text-gray-600">Margin:</span>
                    <div class="text-right">
                      <span class="text-2xl font-bold text-${marginColor}-600">
                        ${data.margin.actualMargin.toFixed(1)}%
                      </span>
                      <div class="text-sm text-gray-500">Target: ${data.margin.targetMargin}%</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `
        } catch (error) {
          document.getElementById('detail-container').innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-6">
              <p class="font-semibold text-red-900">Error loading recipe details</p>
              <p class="text-sm text-red-600 mt-2">${error.message}</p>
            </div>
          `
        }
      }

      function renderCostTree(items, depth = 0) {
        return items
          .map((item) => {
            const indent = depth * 20
            const icon = item.type === 'recipe' ? 'üì¶' : 'ü•ï'
            let html = `
              <div class="py-2" style="padding-left: ${indent}px">
                <div class="flex justify-between items-start">
                  <span class="text-gray-700">
                    ${icon} ${item.name}
                    <span class="text-sm text-gray-500">(${item.amount} ${item.unit})</span>
                  </span>
                  <span class="font-medium text-gray-900 ml-4">¬£${item.cost.toFixed(2)}</span>
                </div>
              </div>
            `
            if (item.children && item.children.length > 0) {
              html += renderCostTree(item.children, depth + 1)
            }
            return html
          })
          .join('')
      }

      // Settings functionality
      async function loadSettings() {
        const form = document.getElementById('settings-form')
        const loading = document.getElementById('settings-loading')

        try {
          form.classList.add('hidden')
          loading.classList.remove('hidden')

          const response = await fetch(`${API_BASE}/settings`)
          if (!response.ok) throw new Error('Failed to load settings')

          const settings = await response.json()

          // Populate form
          document.getElementById('setting-vat').value = settings.vat
          document.getElementById('setting-margin').value =
            settings.marginTarget

          // Set default price includes VAT radio
          const vatRadio = document.querySelector(
            `input[name="defaultPriceIncludesVat"][value="${settings.defaultPriceIncludesVat}"]`
          )
          if (vatRadio) vatRadio.checked = true

          // Update VAT percentage display
          updateVatPercentage(settings.vat)

          loading.classList.add('hidden')
          form.classList.remove('hidden')
        } catch (error) {
          loading.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-6">
              <p class="font-semibold text-red-900">Error loading settings</p>
              <p class="text-sm text-red-600 mt-2">${error.message}</p>
              <button
                onclick="loadSettings()"
                class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm"
              >
                Retry
              </button>
            </div>
          `
          showToast('Failed to load settings. Please try again.', 'error')
        }
      }

      function updateVatPercentage(vat) {
        const percentage = (parseFloat(vat) * 100).toFixed(1)
        document.getElementById('vat-percentage').textContent = `${percentage}%`
      }

      // Update VAT percentage display when input changes
      document.getElementById('setting-vat').addEventListener('input', (e) => {
        updateVatPercentage(e.target.value)
      })

      // Handle settings form submission
      document
        .getElementById('settings-form')
        .addEventListener('submit', async (e) => {
          e.preventDefault()

          const form = e.target
          const submitBtn = form.querySelector('button[type="submit"]')
          const status = document.getElementById('settings-save-status')

          try {
            submitBtn.disabled = true
            submitBtn.textContent = 'Saving...'
            status.innerHTML =
              '<span class="text-gray-600">Saving changes...</span>'

            const formData = new FormData(form)
            const vat = parseFloat(formData.get('vat'))
            const marginTarget = parseInt(formData.get('marginTarget'))

            // Client-side validation
            if (isNaN(vat) || vat < 0 || vat > 1) {
              throw new Error(
                'VAT rate must be between 0 and 1 (e.g., 0.2 for 20%)'
              )
            }
            if (isNaN(marginTarget) || marginTarget < 0 || marginTarget > 100) {
              throw new Error('Margin target must be between 0 and 100')
            }

            const data = {
              vat,
              marginTarget,
              defaultPriceIncludesVat:
                formData.get('defaultPriceIncludesVat') === 'true',
            }

            const response = await fetch(`${API_BASE}/settings`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data),
            })

            if (!response.ok) {
              const contentType = response.headers.get('content-type')
              if (contentType && contentType.includes('application/json')) {
                const error = await response.json()
                throw new Error(error.error || 'Failed to save settings')
              } else {
                throw new Error('Failed to save settings: Server error')
              }
            }

            status.innerHTML =
              '<span class="text-green-600 font-medium">‚úì Settings saved successfully!</span>'
            showToast('Settings saved successfully', 'success')

            // Clear success message after 3 seconds
            setTimeout(() => {
              status.innerHTML = ''
            }, 3000)
          } catch (error) {
            status.innerHTML = `<span class="text-red-600 font-medium">‚úó ${error.message}</span>`
            if (error.message.includes('Failed to fetch')) {
              showToast(
                'Network error: Unable to save settings. Please check your connection.',
                'error'
              )
            } else if (error.message.includes('between')) {
              showToast(`Validation error: ${error.message}`, 'error')
            } else {
              showToast(`Failed to save settings: ${error.message}`, 'error')
            }
          } finally {
            submitBtn.disabled = false
            submitBtn.textContent = 'Save Changes'
          }
        })

      document.getElementById('back-btn').addEventListener('click', () => {
        document.getElementById('recipe-detail').classList.add('hidden')
        document.getElementById('recipe-list').classList.remove('hidden')
      })
    </script>
  </body>
</html>
