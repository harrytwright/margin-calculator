<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Margin Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50">
    <div id="app" class="min-h-screen">
      <!-- Header -->
      <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <h1 class="text-2xl font-bold text-gray-900">üçΩÔ∏è Margin Calculator</h1>
        </div>
      </header>

      <!-- Main Content -->
      <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
        <!-- Management Section -->
        <section class="bg-white border border-gray-200 rounded-lg shadow-sm">
          <div class="border-b border-gray-200 px-6 py-4 flex flex-wrap gap-2">
            <span class="text-sm text-gray-500 mr-4">Manage data:</span>
            <button
              class="manager-tab px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700 focus:outline-none"
              data-manager="suppliers"
              aria-selected="true"
            >
              Suppliers
            </button>
            <button
              class="manager-tab px-4 py-2 text-sm font-medium text-blue-600 border border-blue-200 rounded hover:bg-blue-50 focus:outline-none"
              data-manager="ingredients"
              aria-selected="false"
            >
              Ingredients
            </button>
            <button
              class="manager-tab px-4 py-2 text-sm font-medium text-blue-600 border border-blue-200 rounded hover:bg-blue-50 focus:outline-none"
              data-manager="recipes"
              aria-selected="false"
            >
              Recipes
            </button>
          </div>

          <div class="p-6 space-y-8">
            <!-- Suppliers Manager -->
            <div id="manager-suppliers" class="manager-panel space-y-6">
              <form id="supplier-form" class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700" for="supplier-name"
                    >Supplier Name</label
                  >
                  <input
                    id="supplier-name"
                    name="name"
                    type="text"
                    required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                  />
                </div>

                <div class="flex items-center gap-3">
                  <button
                    type="submit"
                    class="inline-flex items-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 focus:outline-none"
                  >
                    Save Supplier
                  </button>
                  <button
                    type="button"
                    id="supplier-reset"
                    class="inline-flex items-center px-3 py-2 rounded-md border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-50"
                  >
                    Clear
                  </button>
                  <span id="supplier-feedback" class="text-sm text-gray-500"></span>
                </div>
              </form>

              <div>
                <h3 class="text-sm font-semibold text-gray-700 mb-3">Existing Suppliers</h3>
                <div
                  id="supplier-list"
                  class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3"
                ></div>
              </div>
            </div>

            <!-- Ingredients Manager -->
            <div id="manager-ingredients" class="manager-panel space-y-6 hidden">
              <form id="ingredient-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700" for="ingredient-name"
                      >Ingredient Name</label
                    >
                    <input
                      id="ingredient-name"
                      name="name"
                      type="text"
                      required
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700" for="ingredient-category"
                      >Category</label
                    >
                    <input
                      id="ingredient-category"
                      name="category"
                      type="text"
                      required
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    />
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700" for="ingredient-unit"
                      >Purchase Unit</label
                    >
                    <input
                      id="ingredient-unit"
                      name="purchaseUnit"
                      type="text"
                      required
                      placeholder="e.g. 1kg"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700" for="ingredient-cost"
                      >Purchase Cost</label
                    >
                    <input
                      id="ingredient-cost"
                      name="purchaseCost"
                      type="number"
                      min="0"
                      step="0.01"
                      required
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    />
                  </div>
                </div>

                <div class="flex items-center gap-4">
                  <label class="inline-flex items-center text-sm text-gray-700">
                    <input
                      id="ingredient-vat"
                      name="purchaseVat"
                      type="checkbox"
                      class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    />
                    <span class="ml-2">Price includes VAT</span>
                  </label>

                  <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700" for="ingredient-supplier"
                      >Supplier</label
                    >
                    <select
                      id="ingredient-supplier"
                      name="supplier"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    ></select>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700" for="ingredient-conversion"
                      >Conversion Rule (optional)</label
                    >
                    <input
                      id="ingredient-conversion"
                      name="conversionRate"
                      type="text"
                      placeholder="e.g. 1 loaf = 16 slices"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700" for="ingredient-notes"
                      >Notes</label
                    >
                    <input
                      id="ingredient-notes"
                      name="notes"
                      type="text"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    />
                  </div>
                </div>

                <div class="flex items-center gap-3">
                  <button
                    type="submit"
                    class="inline-flex items-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 focus:outline-none"
                  >
                    Save Ingredient
                  </button>
                  <button
                    type="button"
                    id="ingredient-reset"
                    class="inline-flex items-center px-3 py-2 rounded-md border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-50"
                  >
                    Clear
                  </button>
                  <span id="ingredient-feedback" class="text-sm text-gray-500"></span>
                </div>
              </form>

              <div>
                <h3 class="text-sm font-semibold text-gray-700 mb-3">Existing Ingredients</h3>
                <div
                  id="ingredient-list"
                  class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3"
                ></div>
              </div>
            </div>

            <!-- Recipes Manager -->
            <div id="manager-recipes" class="manager-panel space-y-6 hidden">
              <form id="recipe-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700" for="recipe-name"
                      >Recipe Name</label
                    >
                    <input
                      id="recipe-name"
                      name="name"
                      type="text"
                      required
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700" for="recipe-category"
                      >Category (optional)</label
                    >
                    <input
                      id="recipe-category"
                      name="category"
                      type="text"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    />
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700" for="recipe-stage"
                      >Stage</label
                    >
                    <select
                      id="recipe-stage"
                      name="stage"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    >
                      <option value="development">Development</option>
                      <option value="active">Active</option>
                      <option value="discontinued">Discontinued</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700" for="recipe-class"
                      >Class</label
                    >
                    <select
                      id="recipe-class"
                      name="class"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    >
                      <option value="menu_item">Menu Item</option>
                      <option value="base_template">Base Template</option>
                      <option value="sub_recipe">Sub Recipe</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700" for="recipe-parent"
                      >Extends (optional)</label
                    >
                    <select
                      id="recipe-parent"
                      name="extends"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    >
                      <option value="">-- None --</option>
                    </select>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700" for="recipe-price"
                      >Target Price (pence)</label
                    >
                    <input
                      id="recipe-price"
                      name="price"
                      type="number"
                      min="0"
                      step="1"
                      required
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700" for="recipe-margin"
                      >Target Margin (%)</label
                    >
                    <input
                      id="recipe-margin"
                      name="margin"
                      type="number"
                      min="0"
                      max="100"
                      step="1"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    />
                  </div>
                  <div class="flex items-center">
                    <label class="inline-flex items-center text-sm text-gray-700 mt-6">
                      <input
                        id="recipe-vat"
                        name="vat"
                        type="checkbox"
                        class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                      />
                      <span class="ml-2">VAT applicable</span>
                    </label>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700" for="recipe-yield-amount"
                      >Yield Amount (optional)</label
                    >
                    <input
                      id="recipe-yield-amount"
                      name="yieldAmount"
                      type="number"
                      min="0"
                      step="1"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700" for="recipe-yield-unit"
                      >Yield Unit (optional)</label
                    >
                    <input
                      id="recipe-yield-unit"
                      name="yieldUnit"
                      type="text"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    />
                  </div>
                </div>

                <div class="space-y-3">
                  <div class="flex items-center justify-between">
                    <h4 class="text-sm font-semibold text-gray-700">Ingredients</h4>
                    <button
                      type="button"
                      id="add-ingredient-row"
                      class="inline-flex items-center px-3 py-1.5 rounded-md border border-blue-200 text-sm font-medium text-blue-600 hover:bg-blue-50"
                    >
                      Add Ingredient
                    </button>
                  </div>
                  <div id="recipe-ingredients-rows" class="space-y-2"></div>
                </div>

                <div class="flex items-center gap-3">
                  <button
                    type="submit"
                    class="inline-flex items-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 focus:outline-none"
                  >
                    Save Recipe
                  </button>
                  <button
                    type="button"
                    id="recipe-reset"
                    class="inline-flex items-center px-3 py-2 rounded-md border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-50"
                  >
                    Clear
                  </button>
                  <span id="recipe-feedback" class="text-sm text-gray-500"></span>
                </div>
              </form>

              <div>
                <h3 class="text-sm font-semibold text-gray-700 mb-3">Existing Recipes</h3>
                <div id="recipe-manager-list" class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Recipe List View -->
        <section id="recipe-report-section">
          <div id="loading" class="text-center py-12">
            <div
              class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"
            ></div>
            <p class="mt-4 text-gray-600">Loading recipes...</p>
          </div>

          <div id="recipe-list" class="hidden">
            <div class="mb-6 flex items-center justify-between">
              <div>
                <h2 class="text-xl font-semibold text-gray-900">All Recipes</h2>
                <p class="text-gray-600">
                  Click on a recipe to view detailed cost breakdown
                </p>
              </div>
              <div>
                <button
                  type="button"
                  data-manager-switch="recipes"
                  class="inline-flex items-center px-4 py-2 rounded-md border border-blue-200 text-sm font-medium text-blue-600 hover:bg-blue-50"
                >
                  + New Recipe
                </button>
              </div>
            </div>
            <div
              id="recipes-container"
              class="grid gap-4 md:grid-cols-2 lg:grid-cols-3"
            ></div>
          </div>
        </section>

        <!-- Recipe Detail View -->
        <section id="recipe-detail" class="hidden">
          <button
            id="back-btn"
            class="mb-4 text-blue-600 hover:text-blue-800 flex items-center"
          >
            <svg
              class="w-5 h-5 mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
            Back to recipes
          </button>
          <div id="detail-container"></div>
        </section>
      </main>
    </div>

    <script>
      const API_BASE = '/api'
      const state = {
        suppliers: [],
        ingredients: [],
        recipes: [],
        editing: {
          supplier: null,
          ingredient: null,
          recipe: null,
        },
        activeManager: 'suppliers',
      }

      document.addEventListener('DOMContentLoaded', () => {
        bindManagerNavigation()
        bindForms()
        loadManagementData()
        loadRecipeReport()
      })

      async function fetchJSON(pathname, options) {
        const response = await fetch(`${API_BASE}${pathname}`, options)
        if (!response.ok) {
          const payload = await response.text()
          throw new Error(payload || response.statusText)
        }
        const text = await response.text()
        return text ? JSON.parse(text) : null
      }

      async function sendJSON(pathname, method, payload) {
        return fetchJSON(pathname, {
          method,
          headers: {
            'content-type': 'application/json',
          },
          body: JSON.stringify(payload),
        })
      }

      function bindManagerNavigation() {
        document
          .querySelectorAll('.manager-tab')
          .forEach((button) =>
            button.addEventListener('click', () =>
              setActiveManager(button.dataset.manager)
            )
          )

        document
          .querySelectorAll('[data-manager-switch]')
          .forEach((button) =>
            button.addEventListener('click', () =>
              setActiveManager(button.dataset.managerSwitch)
            )
          )
      }

      function setActiveManager(key) {
        state.activeManager = key

        document.querySelectorAll('.manager-tab').forEach((button) => {
          const isActive = button.dataset.manager === key
          button.classList.toggle('bg-blue-600', isActive)
          button.classList.toggle('text-white', isActive)
          button.classList.toggle('border', !isActive)
          button.classList.toggle('border-blue-200', !isActive)
          button.classList.toggle('text-blue-600', !isActive)
          button.setAttribute('aria-selected', String(isActive))
        })

        document.querySelectorAll('.manager-panel').forEach((panel) => {
          panel.classList.add('hidden')
        })

        const activePanel = document.getElementById(`manager-${key}`)
        if (activePanel) {
          activePanel.classList.remove('hidden')
        }
      }

      function bindForms() {
        document
          .getElementById('supplier-form')
          .addEventListener('submit', handleSupplierSubmit)

        document
          .getElementById('supplier-reset')
          .addEventListener('click', clearSupplierForm)

        document
          .getElementById('ingredient-form')
          .addEventListener('submit', handleIngredientSubmit)

        document
          .getElementById('ingredient-reset')
          .addEventListener('click', clearIngredientForm)

        document
          .getElementById('recipe-form')
          .addEventListener('submit', handleRecipeSubmit)

        document
          .getElementById('recipe-reset')
          .addEventListener('click', clearRecipeForm)

        document
          .getElementById('add-ingredient-row')
          .addEventListener('click', () =>
            addIngredientRow(document.getElementById('recipe-ingredients-rows'))
          )

        const ingredientContainer = document.getElementById(
          'recipe-ingredients-rows'
        )
        if (ingredientContainer && ingredientContainer.children.length === 0) {
          addIngredientRow(ingredientContainer)
        }
      }

      function setFeedback(elementId, message, tone = 'info') {
        const el = document.getElementById(elementId)
        el.textContent = message
        el.classList.remove('text-green-600', 'text-red-600', 'text-gray-500')
        if (tone === 'success') {
          el.classList.add('text-green-600')
        } else if (tone === 'error') {
          el.classList.add('text-red-600')
        } else {
          el.classList.add('text-gray-500')
        }
      }

      async function loadManagementData() {
        try {
          const [suppliers, ingredients, recipes] = await Promise.all([
            fetchJSON('/suppliers'),
            fetchJSON('/ingredients'),
            fetchJSON('/recipes'),
          ])

          state.suppliers = suppliers || []
          state.ingredients = ingredients || []
          state.recipes = recipes || []

          renderSupplierList()
          renderIngredientList()
          renderRecipeManagerList()
          populateIngredientSelectors()
        } catch (error) {
          console.error('Failed to load management data', error)
        }
      }

      function renderSupplierList() {
        const container = document.getElementById('supplier-list')
        if (!container) return

        if (state.suppliers.length === 0) {
          container.innerHTML = `
            <div class="col-span-full text-sm text-gray-500">
              No suppliers yet. Use the form above to add one.
            </div>
          `
          return
        }

        container.innerHTML = state.suppliers
          .map(
            (supplier) => `
            <div class="border border-gray-200 rounded-lg p-4 bg-white">
              <h4 class="text-sm font-semibold text-gray-900">${supplier.name}</h4>
              <p class="text-xs text-gray-500 mt-1">slug: ${supplier.slug}</p>
              <div class="mt-3 flex gap-2">
                <button
                  type="button"
                  class="px-3 py-1.5 text-xs rounded-md border border-gray-300 text-gray-600 bg-gray-50"
                  data-action="edit-supplier"
                  data-slug="${supplier.slug}"
                >
                  Edit
                </button>
                <button
                  type="button"
                  class="px-3 py-1.5 text-xs rounded-md border border-gray-200 text-red-600 bg-red-50"
                  data-action="delete-supplier"
                  data-slug="${supplier.slug}"
                >
                  Delete
                </button>
              </div>
            </div>
          `
          )
          .join('')

        container
          .querySelectorAll('[data-action="edit-supplier"]')
          .forEach((button) =>
            button.addEventListener('click', () =>
              startEditSupplier(button.dataset.slug)
            )
          )

        container
          .querySelectorAll('[data-action="delete-supplier"]')
          .forEach((button) =>
            button.addEventListener('click', () =>
              handleDeleteSupplier(button.dataset.slug)
            )
          )
      }

      function renderIngredientList() {
        const container = document.getElementById('ingredient-list')
        if (!container) return

        if (state.ingredients.length === 0) {
          container.innerHTML = `
            <div class="col-span-full text-sm text-gray-500">
              No ingredients yet. Use the form above to add one.
            </div>
          `
          return
        }

        container.innerHTML = state.ingredients
          .map(
            (ingredient) => `
            <div class="border border-gray-200 rounded-lg p-4 bg-white">
              <h4 class="text-sm font-semibold text-gray-900">${ingredient.name}</h4>
              <p class="text-xs text-gray-500">Category: ${
                ingredient.category || '‚Äî'
              }</p>
              <p class="text-xs text-gray-500">Supplier: ${
                ingredient.supplierSlug || 'generic'
              }</p>
              <div class="mt-3 flex gap-2">
                <button
                  type="button"
                  class="px-3 py-1.5 text-xs rounded-md border border-gray-300 text-gray-600 bg-gray-50"
                  data-action="edit-ingredient"
                  data-slug="${ingredient.slug}"
                >
                  Edit
                </button>
                <button
                  type="button"
                  class="px-3 py-1.5 text-xs rounded-md border border-gray-200 text-red-600 bg-red-50"
                  data-action="delete-ingredient"
                  data-slug="${ingredient.slug}"
                >
                  Delete
                </button>
              </div>
            </div>
          `
          )
          .join('')

        container
          .querySelectorAll('[data-action="edit-ingredient"]')
          .forEach((button) =>
            button.addEventListener('click', () =>
              startEditIngredient(button.dataset.slug)
            )
          )

        container
          .querySelectorAll('[data-action="delete-ingredient"]')
          .forEach((button) =>
            button.addEventListener('click', () =>
              handleDeleteIngredient(button.dataset.slug)
            )
          )
      }

      function renderRecipeManagerList() {
        const container = document.getElementById('recipe-manager-list')
        if (!container) return

        if (state.recipes.length === 0) {
          container.innerHTML = `
            <div class="col-span-full text-sm text-gray-500">
              No recipes yet. Use the form above to add one.
            </div>
          `
          return
        }

        container.innerHTML = state.recipes
          .map(
            (recipe) => `
            <div class="border border-gray-200 rounded-lg p-4 bg-white">
              <h4 class="text-sm font-semibold text-gray-900">${recipe.name}</h4>
              <p class="text-xs text-gray-500">Slug: ${recipe.slug}</p>
              <div class="mt-3 flex gap-2">
                <button
                  type="button"
                  class="px-3 py-1.5 text-xs rounded-md border border-gray-300 text-gray-600 bg-gray-50"
                  data-action="edit-recipe"
                  data-slug="${recipe.slug}"
                >
                  Edit
                </button>
                <button
                  type="button"
                  class="px-3 py-1.5 text-xs rounded-md border border-gray-200 text-red-600 bg-red-50"
                  data-action="delete-recipe"
                  data-slug="${recipe.slug}"
                >
                  Delete
                </button>
              </div>
            </div>
          `
          )
          .join('')

        container
          .querySelectorAll('[data-action="edit-recipe"]')
          .forEach((button) =>
            button.addEventListener('click', () =>
              startEditRecipe(button.dataset.slug)
            )
          )

        container
          .querySelectorAll('[data-action="delete-recipe"]')
          .forEach((button) =>
            button.addEventListener('click', () =>
              handleDeleteRecipe(button.dataset.slug)
            )
          )
      }

      function startEditSupplier(slug) {
        const supplier = state.suppliers.find((item) => item.slug === slug)
        if (!supplier) return

        setActiveManager('suppliers')

        document.getElementById('supplier-name').value = supplier.name
        document.querySelector('#supplier-form button[type="submit"]').textContent =
          'Update Supplier'
        document.getElementById('supplier-feedback').textContent = `Editing ${slug}`
        state.editing.supplier = slug
      }

      async function startEditIngredient(slug) {
        setActiveManager('ingredients')
        try {
          const ingredient = await fetchJSON(`/ingredients/${slug}`)
          if (!ingredient) return

          document.getElementById('ingredient-name').value = ingredient.name
          document.getElementById('ingredient-category').value = ingredient.category || ''
          document.getElementById('ingredient-unit').value = ingredient.purchase.unit || ''
          document.getElementById('ingredient-cost').value = ingredient.purchase.cost || 0
          document.getElementById('ingredient-vat').checked = !!ingredient.purchase.vat
          populateIngredientSelectors()
          document.getElementById('ingredient-supplier').value =
            ingredient.supplierSlug || ''
          document.getElementById('ingredient-conversion').value =
            ingredient.conversionRate || ''
          document.getElementById('ingredient-notes').value = ingredient.notes || ''

          document.querySelector('#ingredient-form button[type="submit"]').textContent =
            'Update Ingredient'
          document.getElementById('ingredient-feedback').textContent = `Editing ${slug}`
          state.editing.ingredient = slug
        } catch (error) {
          alert(`Unable to load ingredient: ${error.message}`)
        }
      }

      async function startEditRecipe(slug) {
        setActiveManager('recipes')
        try {
          const recipe = await fetchJSON(`/recipes/${slug}`)
          if (!recipe) return

          document.getElementById('recipe-name').value = recipe.name
          document.getElementById('recipe-category').value = recipe.category || ''
          document.getElementById('recipe-stage').value = recipe.stage || 'development'
          document.getElementById('recipe-class').value = recipe.class || 'menu_item'
          document.getElementById('recipe-parent').value = recipe.parent || ''
          document.getElementById('recipe-price').value = recipe.sellPrice || 0
          document.getElementById('recipe-margin').value = recipe.targetMargin || ''
          document.getElementById('recipe-vat').checked = !!recipe.includesVat
          document.getElementById('recipe-yield-amount').value = recipe.yieldAmount || ''
          document.getElementById('recipe-yield-unit').value = recipe.yieldUnit || ''

          const ingredients = Array.isArray(recipe.ingredients)
            ? recipe.ingredients
            : JSON.parse(recipe.ingredients || '[]')

          const container = document.getElementById('recipe-ingredients-rows')
          container.innerHTML = ''
          if (ingredients.length > 0) {
            ingredients.forEach((item) =>
              addIngredientRow(container, {
                type: item.type || 'ingredient',
                slug: item.slug,
                unit: item.unit || item.with?.unit || '',
              })
            )
          } else {
            addIngredientRow(container)
          }

          populateIngredientSelectors()

          container
            .querySelectorAll('.ingredient-slug')
            .forEach((select, index) => {
              const item = ingredients[index]
              if (item && item.slug) {
                select.value = item.slug
              }
            })

          document.querySelector('#recipe-form button[type="submit"]').textContent =
            'Update Recipe'
          document.getElementById('recipe-feedback').textContent = `Editing ${slug}`
          state.editing.recipe = slug
        } catch (error) {
          alert(`Unable to load recipe: ${error.message}`)
        }
      }

      function clearSupplierForm(resetFeedback = true) {
        document.getElementById('supplier-form').reset()
        if (resetFeedback) {
          document.getElementById('supplier-feedback').textContent = ''
        }
        state.editing.supplier = null
        document.querySelector('#supplier-form button[type="submit"]').textContent =
          'Save Supplier'
      }

      function clearIngredientForm(resetFeedback = true) {
        document.getElementById('ingredient-form').reset()
        if (resetFeedback) {
          document.getElementById('ingredient-feedback').textContent = ''
        }
        state.editing.ingredient = null
        document.querySelector('#ingredient-form button[type="submit"]').textContent =
          'Save Ingredient'
      }

      function clearRecipeForm(resetFeedback = true) {
        document.getElementById('recipe-form').reset()
        if (resetFeedback) {
          document.getElementById('recipe-feedback').textContent = ''
        }
        state.editing.recipe = null
        const rows = document.getElementById('recipe-ingredients-rows')
        rows.innerHTML = ''
        addIngredientRow(rows)
        populateIngredientSelectors()
        document.querySelector('#recipe-form button[type="submit"]').textContent =
          'Save Recipe'
      }

      async function handleSupplierSubmit(event) {
        event.preventDefault()
        const form = event.target
        const submitButton = form.querySelector('button[type="submit"]')
        const name = form.name.value.trim()

        if (!name) {
          setFeedback('supplier-feedback', 'Name is required', 'error')
          return
        }

        const slug = state.editing.supplier
        const payload = { name }

        submitButton.disabled = true
        setFeedback('supplier-feedback', slug ? 'Updating supplier...' : 'Creating supplier...')

        try {
          if (slug) {
            await sendJSON(`/suppliers/${slug}`, 'PUT', payload)
            clearSupplierForm(false)
            setFeedback('supplier-feedback', 'Supplier updated', 'success')
          } else {
            await sendJSON('/suppliers', 'POST', payload)
            clearSupplierForm(false)
            setFeedback('supplier-feedback', 'Supplier created', 'success')
          }

          await loadManagementData()
          await loadRecipeReport()
        } catch (error) {
          setFeedback('supplier-feedback', error.message, 'error')
        } finally {
          submitButton.disabled = false
        }
      }

      async function handleIngredientSubmit(event) {
        event.preventDefault()
        const form = event.target
        const submitButton = form.querySelector('button[type="submit"]')

        const name = form.name.value.trim()
        const category = form.category.value.trim()
        const unit = form.purchaseUnit.value.trim()
        const costValue = form.purchaseCost.value
        const supplierSlug = form.supplier.value
        const conversionRate = form.conversionRate.value.trim()
        const notes = form.notes.value.trim()
        const vat = form.purchaseVat.checked

        const cost = parseFloat(costValue)
        if (!name || !category || !unit || Number.isNaN(cost)) {
          setFeedback('ingredient-feedback', 'Please complete required fields', 'error')
          return
        }

        const payload = {
          name,
          category,
          purchase: {
            unit,
            cost,
            vat,
          },
          supplier: supplierSlug
            ? { uses: `slug:${supplierSlug}` }
            : undefined,
          conversionRate: conversionRate || undefined,
          notes: notes || undefined,
        }

        const slug = state.editing.ingredient
        submitButton.disabled = true
        setFeedback(
          'ingredient-feedback',
          slug ? 'Updating ingredient...' : 'Creating ingredient...'
        )

        try {
          if (slug) {
            await sendJSON(`/ingredients/${slug}`, 'PUT', payload)
            clearIngredientForm(false)
            setFeedback('ingredient-feedback', 'Ingredient updated', 'success')
          } else {
            await sendJSON('/ingredients', 'POST', payload)
            clearIngredientForm(false)
            setFeedback('ingredient-feedback', 'Ingredient created', 'success')
          }

          await loadManagementData()
          await loadRecipeReport()
        } catch (error) {
          setFeedback('ingredient-feedback', error.message, 'error')
        } finally {
          submitButton.disabled = false
        }
      }

      async function handleRecipeSubmit(event) {
        event.preventDefault()
        const form = event.target
        const submitButton = form.querySelector('button[type="submit"]')

        const name = form.name.value.trim()
        const category = form.category.value.trim()
        const stage = form.stage.value
        const recipeClass = form.class.value
        const parent = form.extends.value
        const priceValue = form.price.value
        const marginValue = form.margin.value
        const vat = form.vat.checked
        const yieldAmountValue = form.yieldAmount.value
        const yieldUnit = form.yieldUnit.value.trim()

        const price = Number(priceValue)
        if (!name || Number.isNaN(price)) {
          setFeedback('recipe-feedback', 'Name and price are required', 'error')
          return
        }

        const ingredients = collectIngredientRows()
          .filter((row) => row.slug && row.unit)
          .map((row) => ({
            type: row.type,
            uses: `slug:${row.slug}`,
            with: { unit: row.unit },
          }))

        const payload = {
          name,
          category: category || undefined,
          stage,
          class: recipeClass,
          costing: {
            price,
            margin: marginValue ? Number(marginValue) : undefined,
            vat,
          },
          ingredients,
          yieldAmount: yieldAmountValue ? Number(yieldAmountValue) : undefined,
          yieldUnit: yieldUnit || undefined,
        }

        if (parent) {
          payload.extends = `slug:${parent}`
        }

        const slug = state.editing.recipe
        submitButton.disabled = true
        setFeedback('recipe-feedback', slug ? 'Updating recipe...' : 'Creating recipe...')

        try {
          if (slug) {
            await sendJSON(`/recipes/${slug}`, 'PUT', payload)
            clearRecipeForm(false)
            setFeedback('recipe-feedback', 'Recipe updated', 'success')
          } else {
            await sendJSON('/recipes', 'POST', payload)
            clearRecipeForm(false)
            setFeedback('recipe-feedback', 'Recipe created', 'success')
          }

          await loadManagementData()
          await loadRecipeReport()
        } catch (error) {
          setFeedback('recipe-feedback', error.message, 'error')
        } finally {
          submitButton.disabled = false
        }
      }

      async function handleDeleteSupplier(slug) {
        if (!confirm(`Delete supplier "${slug}"?`)) return
        try {
          await fetchJSON(`/suppliers/${slug}`, { method: 'DELETE' })
          if (state.editing.supplier === slug) {
            clearSupplierForm(false)
          }
          setFeedback('supplier-feedback', 'Supplier deleted', 'success')
          await loadManagementData()
          await loadRecipeReport()
        } catch (error) {
          setFeedback('supplier-feedback', error.message, 'error')
        }
      }

      async function handleDeleteIngredient(slug) {
        if (!confirm(`Delete ingredient "${slug}"?`)) return
        try {
          await fetchJSON(`/ingredients/${slug}`, { method: 'DELETE' })
          if (state.editing.ingredient === slug) {
            clearIngredientForm(false)
          }
          setFeedback('ingredient-feedback', 'Ingredient deleted', 'success')
          await loadManagementData()
          await loadRecipeReport()
        } catch (error) {
          setFeedback('ingredient-feedback', error.message, 'error')
        }
      }

      async function handleDeleteRecipe(slug) {
        if (!confirm(`Delete recipe "${slug}"?`)) return
        try {
          await fetchJSON(`/recipes/${slug}`, { method: 'DELETE' })
          if (state.editing.recipe === slug) {
            clearRecipeForm(false)
          }
          setFeedback('recipe-feedback', 'Recipe deleted', 'success')
          await loadManagementData()
          await loadRecipeReport()
        } catch (error) {
          setFeedback('recipe-feedback', error.message, 'error')
        }
      }

      function addIngredientRow(container, initial) {
        const row = document.createElement('div')
        row.className = 'ingredient-row flex flex-col md:flex-row md:items-center gap-2 border border-gray-200 rounded-md p-3 bg-gray-50'
        row.innerHTML = `
          <div class="flex-1 flex gap-2">
            <select class="ingredient-type rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
              <option value="ingredient">Ingredient</option>
              <option value="recipe">Recipe</option>
            </select>
            <select class="ingredient-slug flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
              <option value="">-- Select --</option>
            </select>
            <input
              type="text"
              class="ingredient-unit w-32 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              placeholder="Unit"
            />
          </div>
          <button
            type="button"
            class="remove-ingredient-row px-3 py-1.5 text-xs rounded-md border border-red-200 text-red-600 bg-red-50"
          >
            Remove
          </button>
        `

        container.appendChild(row)

        const typeSelect = row.querySelector('.ingredient-type')
        typeSelect.addEventListener('change', () => populateIngredientSelectors())

        row.querySelector('.remove-ingredient-row').addEventListener('click', () => {
          if (container.children.length > 1) {
            row.remove()
          }
        })

        if (initial) {
          typeSelect.value = initial.type || 'ingredient'
          row.querySelector('.ingredient-unit').value = initial.unit || ''
        }

        populateIngredientSelectors()

        if (initial && initial.slug) {
          row.querySelector('.ingredient-slug').value = initial.slug
        }
      }

      function collectIngredientRows() {
        return Array.from(
          document.querySelectorAll('#recipe-ingredients-rows .ingredient-row')
        ).map((row) => ({
          type: row.querySelector('.ingredient-type').value,
          slug: row.querySelector('.ingredient-slug').value,
          unit: row.querySelector('.ingredient-unit').value,
        }))
      }

      function populateIngredientSelectors() {
        const ingredientOptions = state.ingredients
          .map((ing) => `<option value="${ing.slug}">${ing.name}</option>`)
          .join('')

        const recipeOptions = state.recipes
          .map((rec) => `<option value="${rec.slug}">${rec.name}</option>`)
          .join('')

        document
          .querySelectorAll('#recipe-ingredients-rows .ingredient-row')
          .forEach((row) => {
            const typeSelect = row.querySelector('.ingredient-type')
            const slugSelect = row.querySelector('.ingredient-slug')
            const current = slugSelect.value
            if (typeSelect.value === 'recipe') {
            slugSelect.innerHTML = `<option value="">-- Select --</option>${recipeOptions}`
          } else {
            slugSelect.innerHTML = `<option value="">-- Select --</option>${ingredientOptions}`
          }
          slugSelect.value = current
        })

        const supplierSelect = document.getElementById('ingredient-supplier')
        if (supplierSelect) {
          supplierSelect.innerHTML = state.suppliers
            .map((supplier) => `<option value="${supplier.slug}">${supplier.name}</option>`)
            .join('')
        }

        const parentSelect = document.getElementById('recipe-parent')
        if (parentSelect) {
          const preserve = parentSelect.value
          parentSelect.innerHTML = '<option value="">-- None --</option>' +
            state.recipes.map((recipe) => `<option value="${recipe.slug}">${recipe.name}</option>`).join('')
          parentSelect.value = preserve
        }
      }

      async function loadRecipeReport() {
        try {
          const recipes = await fetchJSON('/report')

          document.getElementById('loading').classList.add('hidden')
          document.getElementById('recipe-list').classList.remove('hidden')

          const container = document.getElementById('recipes-container')
          container.innerHTML = recipes
            .map((recipe) => {
              if (!recipe.success) {
                return `
                  <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <h3 class="font-semibold text-red-900">${recipe.slug}</h3>
                    <p class="text-sm text-red-600 mt-1">Error: ${recipe.error}</p>
                  </div>
                `
              }

              const marginColor = recipe.margin.meetsTarget ? 'green' : 'red'
              const marginIcon = recipe.margin.meetsTarget ? '‚úì' : '‚úó'

              return `
                <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow cursor-pointer"
                     onclick="loadRecipeDetail('${recipe.slug}')">
                  <h3 class="font-semibold text-gray-900 text-lg mb-2">${recipe.name}</h3>
                  <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                      <span class="text-gray-600">Cost:</span>
                      <span class="font-medium">¬£${recipe.cost.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600">Sell Price:</span>
                      <span class="font-medium">¬£${recipe.margin.sellPrice.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t">
                      <span class="text-gray-600">Margin:</span>
                      <span class="font-semibold text-${marginColor}-600">
                        ${marginIcon} ${recipe.margin.actualMargin.toFixed(1)}%
                      </span>
                    </div>
                    <div class="text-xs text-gray-500">Target: ${recipe.margin.targetMargin}%</div>
                  </div>
                </div>
              `
            })
            .join('')
        } catch (error) {
          document.getElementById('loading').innerHTML = `
            <div class="text-red-600">
              <p class="font-semibold">Error loading recipes</p>
              <p class="text-sm mt-2">${error.message}</p>
            </div>
          `
        }
      }

      async function loadRecipeDetail(slug) {
        try {
          document.getElementById('recipe-list').classList.add('hidden')
          document.getElementById('recipe-detail').classList.remove('hidden')

          const data = await fetchJSON(`/recipes/${slug}/calculate`)

          const container = document.getElementById('detail-container')
          const marginColor = data.margin.meetsTarget ? 'green' : 'red'

          container.innerHTML = `
            <div class="bg-white border border-gray-200 rounded-lg p-6">
              <h2 class="text-2xl font-bold text-gray-900 mb-4">${data.recipe.name}</h2>
              <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Cost Breakdown</h3>
                <div class="bg-gray-50 rounded-lg p-4">
                  ${renderCostTree(data.cost.breakdown)}
                  <div class="mt-4 pt-4 border-t border-gray-300">
                    <div class="flex justify-between text-lg font-semibold">
                      <span>Total Cost:</span>
                      <span>¬£${data.cost.total.toFixed(2)}</span>
                    </div>
                  </div>
                </div>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Pricing & Margin</h3>
                <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                  <div class="flex justify-between">
                    <span class="text-gray-600">Sell Price (ex-VAT):</span>
                    <span class="font-medium">¬£${data.margin.sellPrice.toFixed(2)}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Customer Price:</span>
                    <span class="font-medium">¬£${data.margin.customerPrice.toFixed(2)}</span>
                  </div>
                  ${
                    data.margin.vatApplicable
                      ? `
                        <div class="flex justify-between text-sm text-gray-500">
                          <span>VAT:</span>
                          <span>¬£${data.margin.vatAmount.toFixed(2)}</span>
                        </div>
                      `
                      : '<div class="text-sm text-gray-500">VAT not applicable</div>'
                  }
                  <div class="flex justify-between pt-3 border-t">
                    <span class="text-gray-600">Profit:</span>
                    <span class="font-medium text-green-600">¬£${data.margin.profit.toFixed(2)}</span>
                  </div>
                  <div class="flex justify-between items-center pt-3 border-t">
                    <span class="text-gray-600">Margin:</span>
                    <div class="text-right">
                      <span class="text-2xl font-bold text-${marginColor}-600">
                        ${data.margin.actualMargin.toFixed(1)}%
                      </span>
                      <div class="text-sm text-gray-500">Target: ${data.margin.targetMargin}%</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `
        } catch (error) {
          document.getElementById('detail-container').innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-6">
              <p class="font-semibold text-red-900">Error loading recipe details</p>
              <p class="text-sm text-red-600 mt-2">${error.message}</p>
            </div>
          `
        }
      }

      function renderCostTree(items, depth = 0) {
        return items
          .map((item) => {
            const indent = depth * 20
            const icon = item.type === 'recipe' ? 'üì¶' : 'ü•ï'
            let html = `
              <div class="py-2" style="padding-left: ${indent}px">
                <div class="flex justify-between items-start">
                  <span class="text-gray-700">
                    ${icon} ${item.name}
                    <span class="text-sm text-gray-500">(${item.amount} ${item.unit})</span>
                  </span>
                  <span class="font-medium text-gray-900 ml-4">¬£${item.cost.toFixed(2)}</span>
                </div>
              </div>
            `
            if (item.children && item.children.length > 0) {
              html += renderCostTree(item.children, depth + 1)
            }
            return html
          })
          .join('')
      }

      document.getElementById('back-btn').addEventListener('click', () => {
        document.getElementById('recipe-detail').classList.add('hidden')
        document.getElementById('recipe-list').classList.remove('hidden')
      })
    </script>
  </body>
</html>
