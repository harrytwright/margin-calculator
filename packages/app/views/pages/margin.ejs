<%
  const marginsList = typeof margins !== 'undefined' ? margins : []
  const totalRecipes = marginsList.length
  const avgMargin = totalRecipes > 0
    ? (marginsList.reduce((sum, m) => sum + m.actualMargin, 0) / totalRecipes).toFixed(1)
    : 0
  const avgProfit = totalRecipes > 0
    ? (marginsList.reduce((sum, m) => sum + m.profit, 0) / totalRecipes).toFixed(2)
    : 0

  function formatCurrency(value) {
    return `Â£${(value / 100).toFixed(2)}`
  }

  function getMarginColor(margin, target) {
    if (margin >= target) return 'text-success'
    if (margin >= target * 0.8) return 'text-warning'
    return 'text-error'
  }

  function getMarginBadge(margin, target) {
    if (margin >= target) return 'badge-success'
    if (margin >= target * 0.8) return 'badge-warning'
    return 'badge-error'
  }
%>

<div class="space-y-6">
  <!-- Header with Stats -->
  <div class="flex justify-between items-start">
    <div>
      <h1 class="text-2xl font-bold text-base-content">Margin Calculator</h1>
      <p class="text-sm text-base-content/70 mt-1">
        <%= totalRecipes %> recipe<%= totalRecipes !== 1 ? 's' : '' %> analyzed
      </p>
    </div>

    <!-- Summary Stats -->
    <div class="stats shadow bg-base-100">
      <div class="stat">
        <div class="stat-title">Avg Margin</div>
        <div class="stat-value text-primary text-2xl"><%= avgMargin %>%</div>
      </div>
      <div class="stat">
        <div class="stat-title">Avg Profit</div>
        <div class="stat-value text-secondary text-2xl"><%= formatCurrency(avgProfit * 100) %></div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card bg-base-100 shadow-sm">
    <div class="card-body py-4">
      <form
        hx-get="/margin"
        hx-target="#content-area"
        hx-push-url="true"
        hx-trigger="change, submit"
        class="flex flex-wrap gap-4"
      >
        <div class="form-control flex-1 min-w-[200px]">
          <input
            type="text"
            name="search"
            placeholder="Search recipes..."
            value="<%= typeof search !== 'undefined' ? search : '' %>"
            class="input input-bordered w-full"
          />
        </div>
        <div class="form-control">
          <select name="filter-class" class="select select-bordered">
            <option value="">All Types</option>
            <option value="menu_item" <%= (typeof filterClass !== 'undefined' && filterClass === 'menu_item') ? 'selected' : '' %>>Menu Items</option>
            <option value="sub_recipe" <%= (typeof filterClass !== 'undefined' && filterClass === 'sub_recipe') ? 'selected' : '' %>>Sub Recipes</option>
            <option value="base_template" <%= (typeof filterClass !== 'undefined' && filterClass === 'base_template') ? 'selected' : '' %>>Base Templates</option>
          </select>
        </div>
        <button type="submit" class="btn btn-ghost">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </button>
      </form>
    </div>
  </div>

  <!-- Error Message -->
  <% if (typeof error !== 'undefined' && error) { %>
  <div class="alert alert-error">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <span><%= error %></span>
  </div>
  <% } %>

  <!-- Margins Table -->
  <% if (marginsList.length === 0) { %>
  <div class="card bg-base-100 shadow">
    <div class="card-body items-center text-center">
      <svg class="w-16 h-16 text-base-content/20 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
      </svg>
      <h3 class="card-title text-base-content/60">No recipes found</h3>
      <p class="text-base-content/40">Add recipes with sell prices to see margin calculations</p>
    </div>
  </div>
  <% } else { %>
  <div class="card bg-base-100 shadow">
    <div class="overflow-x-auto">
      <table class="table table-zebra">
        <thead>
          <tr>
            <th>Recipe</th>
            <th>Type</th>
            <th class="text-right">Sell Price</th>
            <th class="text-right">Food Cost</th>
            <th class="text-right">Profit</th>
            <th class="text-right">Margin</th>
            <th class="text-right">Target</th>
            <th class="text-center">Status</th>
          </tr>
        </thead>
        <tbody>
          <% marginsList.forEach(margin => { %>
          <tr class="hover">
            <td>
              <div class="flex flex-col">
                <span class="font-medium"><%= margin.name %></span>
                <span class="text-xs text-base-content/60"><%= margin.slug %></span>
              </div>
            </td>
            <td>
              <% if (margin.class === 'menu_item') { %>
                <span class="badge badge-sm badge-primary">Menu Item</span>
              <% } else if (margin.class === 'sub_recipe') { %>
                <span class="badge badge-sm badge-secondary">Sub Recipe</span>
              <% } else { %>
                <span class="badge badge-sm">Template</span>
              <% } %>
            </td>
            <td class="text-right font-mono">
              <%= formatCurrency(margin.sellPrice) %>
              <% if (!margin.includesVat) { %>
                <span class="text-xs text-base-content/60">ex. VAT</span>
              <% } %>
            </td>
            <td class="text-right font-mono">
              <%= formatCurrency(margin.foodCost) %>
            </td>
            <td class="text-right font-mono font-semibold">
              <%= formatCurrency(margin.profit) %>
            </td>
            <td class="text-right">
              <span class="font-bold text-lg <%= getMarginColor(margin.actualMargin, margin.targetMargin) %>">
                <%= margin.actualMargin.toFixed(1) %>%
              </span>
            </td>
            <td class="text-right text-base-content/60">
              <%= margin.targetMargin.toFixed(0) %>%
            </td>
            <td class="text-center">
              <% if (margin.error) { %>
                <div class="tooltip" data-tip="<%= margin.error %>">
                  <span class="badge badge-error badge-sm">Error</span>
                </div>
              <% } else if (margin.actualMargin >= margin.targetMargin) { %>
                <span class="badge <%= getMarginBadge(margin.actualMargin, margin.targetMargin) %> badge-sm">
                  Meets Target
                </span>
              <% } else if (margin.actualMargin >= margin.targetMargin * 0.8) { %>
                <span class="badge <%= getMarginBadge(margin.actualMargin, margin.targetMargin) %> badge-sm">
                  Close
                </span>
              <% } else { %>
                <span class="badge <%= getMarginBadge(margin.actualMargin, margin.targetMargin) %> badge-sm">
                  Below Target
                </span>
              <% } %>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
  <% } %>
</div>
