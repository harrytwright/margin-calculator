<%
  /**
   * Browser Island - File tree component
   *
   * Props:
   * - type: 'recipes' | 'ingredients' | 'suppliers'
   * - items: Array of items to display
   * - selectedSlug: Currently selected item's slug
   * - groupBy: Property to group items by (e.g., 'category', 'type')
   * - onSelect: URL pattern for selection (e.g., '/recipes/:slug')
   */

  const typeLabels = {
    recipes: 'Recipes',
    ingredients: 'Ingredients',
    suppliers: 'Suppliers',
  }

  const typeIcons = {
    recipes: 'book',
    ingredients: 'package',
    suppliers: 'truck',
  }

  // Group items if groupBy is specified
  let groupedItems = {}
  if (groupBy && items) {
    items.forEach(item => {
      const groupKey = item[groupBy] || 'Uncategorized'
      if (!groupedItems[groupKey]) {
        groupedItems[groupKey] = []
      }
      groupedItems[groupKey].push(item)
    })
  } else if (items) {
    groupedItems['All'] = items
  }

  const groups = Object.keys(groupedItems).sort()
%>

<!-- Browser Island -->
<div
  id="<%= type %>-browser"
  class="h-full flex flex-col bg-white dark:bg-gray-800 rounded-island shadow-island overflow-hidden"
  hx-get="/api/<%= type %>/list"
  hx-trigger="refresh"
  hx-swap="innerHTML"
>
  <!-- Header -->
  <div class="flex items-center justify-between px-3 py-2 border-b border-gray-200 dark:border-gray-700">
    <h3 class="text-sm font-medium text-gray-700 dark:text-gray-200">
      <%= typeLabels[type] || type %>
    </h3>
    <button
      hx-get="/<%= type %>/new"
      hx-target=".modal-content"
      onclick="openModal()"
      class="w-6 h-6 flex items-center justify-center rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400 transition-colors"
      title="Add new"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
      </svg>
    </button>
  </div>

  <!-- Search/Filter -->
  <div class="px-3 py-2 border-b border-gray-100 dark:border-gray-700/50">
    <div class="relative">
      <input
        type="text"
        placeholder="Filter..."
        class="w-full h-7 pl-7 pr-2 text-xs rounded bg-gray-100 dark:bg-gray-700 border-0 text-gray-700 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-1 focus:ring-blue-500"
        id="<%= type %>-filter"
        onkeyup="filterTree('<%= type %>')"
      />
      <svg class="absolute left-2 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>
    </div>
  </div>

  <!-- Tree Content -->
  <div class="flex-1 overflow-y-auto py-1">
    <% if (!items || items.length === 0) { %>
    <div class="px-3 py-8 text-center">
      <div class="w-10 h-10 mx-auto mb-3 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
        </svg>
      </div>
      <p class="text-sm text-gray-500 dark:text-gray-400">No <%= type %> yet</p>
      <button
        hx-get="/<%= type %>/new"
        hx-target=".modal-content"
        onclick="openModal()"
        class="mt-2 text-xs text-blue-600 dark:text-blue-400 hover:underline"
      >
        Add your first one
      </button>
    </div>
    <% } else { %>
    <% groups.forEach((group, groupIndex) => { %>
    <div class="<%= type %>-tree-group" data-group="<%= group.toLowerCase() %>">
      <% if (groups.length > 1 || group !== 'All') { %>
      <!-- Group Header -->
      <button
        class="w-full flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700/50"
        onclick="toggleGroup(this)"
      >
        <svg class="w-3 h-3 transition-transform group-expanded:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
        <span><%= group %></span>
        <span class="ml-auto text-gray-400 dark:text-gray-500"><%= groupedItems[group].length %></span>
      </button>
      <% } %>

      <!-- Group Items -->
      <div class="<%= type %>-tree-items">
        <% groupedItems[group].forEach(item => { %>
        <a
          href="/<%= type %>/<%= item.slug %>"
          hx-get="/<%= type %>/<%= item.slug %>"
          hx-target="#<%= type %>-editor"
          hx-push-url="true"
          data-<%= type %>-item="<%= item.slug %>"
          onclick="selectItem('<%= type %>', '<%= item.slug %>')"
          class="<%= type %>-tree-item flex items-center gap-2 px-3 py-1.5 text-sm cursor-pointer transition-colors
            <%= selectedSlug === item.slug
              ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300'
              : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50'
            %>"
        >
          <% if (type === 'recipes') { %>
          <svg class="w-4 h-4 shrink-0 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          <% } else if (type === 'ingredients') { %>
          <svg class="w-4 h-4 shrink-0 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
          </svg>
          <% } else { %>
          <svg class="w-4 h-4 shrink-0 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
          </svg>
          <% } %>
          <span class="truncate"><%= item.name %></span>
        </a>
        <% }) %>
      </div>
    </div>
    <% }) %>
    <% } %>
  </div>
</div>

<script>
  // Filter tree items
  function filterTree(type) {
    const filter = document.getElementById(`${type}-filter`).value.toLowerCase();
    const items = document.querySelectorAll(`.${type}-tree-item`);

    items.forEach(item => {
      const text = item.textContent.toLowerCase();
      item.style.display = text.includes(filter) ? '' : 'none';
    });

    // Show/hide groups based on visible items
    document.querySelectorAll(`.${type}-tree-group`).forEach(group => {
      const visibleItems = group.querySelectorAll(`.${type}-tree-item:not([style*="display: none"])`);
      group.style.display = visibleItems.length > 0 ? '' : 'none';
    });
  }

  // Toggle group collapse
  function toggleGroup(button) {
    const itemsContainer = button.nextElementSibling;
    const chevron = button.querySelector('svg');

    if (itemsContainer.style.display === 'none') {
      itemsContainer.style.display = '';
      chevron.style.transform = '';
    } else {
      itemsContainer.style.display = 'none';
      chevron.style.transform = 'rotate(-90deg)';
    }
  }
</script>
